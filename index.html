<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Election Data Dashboard with Results Tab</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; max-width: 1000px; }
    h1 { margin-bottom: 15px; }
    /* Tabs container */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      cursor: pointer;
    }
    .tab {
      padding: 10px 20px;
      background: #eee;
      border-radius: 4px 4px 0 0;
      border: 1px solid #ccc;
      border-bottom: none;
      user-select: none;
    }
    .tab.active {
      background: white;
      font-weight: bold;
      border-bottom: 2px solid white;
    }
    /* Tab content sections */
    .tab-content {
      border: 1px solid #ccc;
      border-radius: 0 4px 4px 4px;
      padding: 20px;
      background: white;
      min-height: 500px;
    }
    /* Shared Controls styles */
    label, input, select {
      display: inline-block;
      margin-bottom: 10px;
    }
    select, input[type="text"] {
      padding: 6px;
      margin-left: 8px;
      min-width: 150px;
      vertical-align: middle;
    }
    #districtsSelect {
      width: 320px;
      height: 110px;
    }
    #districtSearch {
      width: 320px;
      margin-bottom: 10px;
      padding: 6px;
      display: block;
    }
    /* Summary styles */
    .summary p {
      margin: 4px 0;
      font-size: 1em;
    }
    /* Tables */
    table {
      border-collapse: collapse;
      margin-top: 15px;
      width: 100%;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px 12px;
      text-align: right;
    }
    th:first-child, td:first-child {
      text-align: left;
    }
    /* Results tab filters container */
    #resultsFilters {
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: flex-end;
    }
    #resultsFilters label {
      margin-bottom: 0;
    }
    /* Responsive tweaks */
    @media(max-width: 700px) {
      #resultsFilters {
        flex-direction: column;
        align-items: flex-start;
      }
      select, input[type="text"] {
        width: 100%;
      }
      #districtsSelect {
        width: 100%;
        height: 120px;
      }
    }
  </style>
</head>
<body>

  <h1>Election Data Dashboard</h1>

  <div class="tabs">
    <div id="tabDashboard" class="tab active">Dashboard</div>
    <div id="tabResults" class="tab">Results</div>
  </div>

  <!-- Dashboard Tab Content -->
  <div id="dashboardContent" class="tab-content">
    <div>
      <label for="yearSelectDashboard">Select Year:</label>
      <select id="yearSelectDashboard"></select>
    </div>

 <div class="summary">
      <p><strong>Total Registered Voters:</strong> <span id="totalRegisteredVoters">-</span></p>
      <p><strong>Total Turnout (Votes):</strong> <span id="totalTurnout">-</span></p>
      <p><strong>Turnout %:</strong> <span id="turnoutPercent">-</span></p>
      <p><strong>Number of Districts:</strong> <span id="numDistricts">-</span></p>
    </div>





    
    <div>
      <label for="districtSearchDashboard">Search District:</label>
      <input type="text" id="districtSearchDashboard" placeholder="Type to search district..." autocomplete="off" />
    </div>

    <div>
      <label for="districtsSelectDashboard">Select District(s):</label>
      <select id="districtsSelectDashboard" multiple></select>
    </div>

    <div>
      <label for="naSelectDashboard">Select NA:</label>
      <select id="naSelectDashboard"><option value="">-- All NAs --</option></select>
    </div>

    
   

    <hr>

    <h2>District-wise Analysis</h2>
    <div id="districtAnalysis"><p>Please select one or more districts to compare.</p></div>
  </div>

     <canvas id="yearChart" width="800" height="400" style="max-width:100%;"></canvas>

  
  <!-- Results Tab Content -->
  <div id="resultsContent" class="tab-content" style="display:none;">
    <div id="resultsFilters">
      <div>
        <label for="yearSelectResults">Year:</label><br />
        <select id="yearSelectResults"></select>
      </div>
      <div>
        <label for="districtSelectResults">District:</label><br />
        <select id="districtSelectResults"><option value="">-- All Districts --</option></select>
      </div>
      <div>
        <label for="naSelectResults">NA:</label><br />
        <select id="naSelectResults"><option value="">-- All NAs --</option></select>
      </div>
    </div>

    <div id="summaryResults" style="margin-bottom: 15px; font-weight: bold;"></div>

    <table id="resultsTable" style="display:none;">
      <thead>
        <tr>
          <th>Candidate Name</th>
          <th>Party</th>
          <th>Votes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <canvas id="partyChart" width="800" height="400" style="display:none; max-width:100%;"></canvas>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // === Variables for Tabs ===
    const tabDashboard = document.getElementById('tabDashboard');
    const tabResults = document.getElementById('tabResults');
    const dashboardContent = document.getElementById('dashboardContent');
    const resultsContent = document.getElementById('resultsContent');

    tabDashboard.addEventListener('click', () => {
      tabDashboard.classList.add('active');
      tabResults.classList.remove('active');
      dashboardContent.style.display = 'block';
      resultsContent.style.display = 'none';
    });

    tabResults.addEventListener('click', () => {
      tabResults.classList.add('active');
      tabDashboard.classList.remove('active');
      resultsContent.style.display = 'block';
      dashboardContent.style.display = 'none';
    });

    // === Common CSV URL ===
    const csvUrl = 'https://raw.githubusercontent.com/mallikamin/PakElections/main/data.csv';

    // === Global data holders ===
    let electionData = [];

    // === Helper parse number ===
    function parseNumber(val) {
      const num = Number(val);
      return isNaN(num) ? 0 : num;
    }

    // === Load data once and initialize both tabs ===
    Papa.parse(csvUrl, {
      download: true,
      header: true,
      dynamicTyping: false,
      complete: function (results) {
        electionData = results.data.filter(row => row.Year && row.Year.trim() !== '');
        initDashboardTab();
        initResultsTab();
      },
      error: function(err) {
        alert('Error loading CSV: ' + err);
      }
    });

    // ------------- DASHBOARD TAB CODE --------------

    const yearSelectDashboard = document.getElementById('yearSelectDashboard');
    const districtSearchDashboard = document.getElementById('districtSearchDashboard');
    const districtsSelectDashboard = document.getElementById('districtsSelectDashboard');
    const naSelectDashboard = document.getElementById('naSelectDashboard');

    const totalRegisteredVotersSpan = document.getElementById('totalRegisteredVoters');
    const totalTurnoutSpan = document.getElementById('totalTurnout');
    const turnoutPercentSpan = document.getElementById('turnoutPercent');
    const numDistrictsSpan = document.getElementById('numDistricts');

    const yearChartCtx = document.getElementById('yearChart').getContext('2d');
    const districtAnalysisDiv = document.getElementById('districtAnalysis');

    let yearChart;

    function initDashboardTab() {
      // Populate years dropdown
      const years = [...new Set(electionData.map(r => r.Year.trim()))].sort();
      yearSelectDashboard.innerHTML = '';
      years.forEach(y => {
        const option = document.createElement('option');
        option.value = y;
        option.textContent = y;
        yearSelectDashboard.appendChild(option);
      });

      // Set default year selection
      yearSelectDashboard.value = years[0];

      yearSelectDashboard.addEventListener('change', () => {
        populateDistrictsDashboard(yearSelectDashboard.value.trim());
        populateNASelectDashboard();
        districtSearchDashboard.value = '';
        districtAnalysisDiv.innerHTML = '<p>Please select one or more districts to compare.</p>';
        districtsSelectDashboard.selectedIndex = -1;
        naSelectDashboard.value = "";
        updateDashboardSummary();
      });

      districtSearchDashboard.addEventListener('input', filterDistrictsDashboard);

      districtsSelectDashboard.addEventListener('change', () => {
        populateNASelectDashboard();
        updateDistrictAnalysis();
      });

      naSelectDashboard.addEventListener('change', updateDistrictAnalysis);

      // Initial population and update
      populateDistrictsDashboard(yearSelectDashboard.value.trim());
      populateNASelectDashboard();
      updateDashboardSummary();
    }

    function populateDistrictsDashboard(year) {
      const districts = [...new Set(electionData
        .filter(r => r.Year.trim() === year && r.District && r.District.trim() !== '')
        .map(r => r.District.trim())
      )].sort();

      districtsSelectDashboard.innerHTML = '';
      districts.forEach(d => {
        const option = document.createElement('option');
        option.value = d;
        option.textContent = d;
        districtsSelectDashboard.appendChild(option);
      });
    }

    function filterDistrictsDashboard() {
      const search = districtSearchDashboard.value.trim().toLowerCase();
      const year = yearSelectDashboard.value.trim();

      const districts = [...new Set(electionData
        .filter(r => r.Year.trim() === year && r.District && r.District.trim() !== '')
        .map(r => r.District.trim())
      )].sort();

      const filtered = districts.filter(d => d.toLowerCase().includes(search));

      // Preserve selection
      const selectedValues = Array.from(districtsSelectDashboard.selectedOptions).map(o => o.value);

      districtsSelectDashboard.innerHTML = '';
      filtered.forEach(d => {
        const option = document.createElement('option');
        option.value = d;
        option.textContent = d;
        if (selectedValues.includes(d)) option.selected = true;
        districtsSelectDashboard.appendChild(option);
      });
    }

    function populateNASelectDashboard() {
      const year = yearSelectDashboard.value.trim();
      const selectedDistricts = Array.from(districtsSelectDashboard.selectedOptions).map(o => o.value);

      let naOptions;

      if (selectedDistricts.length) {
        naOptions = [...new Set(electionData
          .filter(r => r.Year.trim() === year && r.NA && r.NA.trim() !== '' && selectedDistricts.includes(r.District.trim()))
          .map(r => r.NA.trim())
        )];
      } else {
        naOptions = [...new Set(electionData
          .filter(r => r.Year.trim() === year && r.NA && r.NA.trim() !== '')
          .map(r => r.NA.trim())
        )];
      }

      naOptions.sort();

      const currentNA = naSelectDashboard.value;

      naSelectDashboard.innerHTML = '<option value="">-- All NAs --</option>';
      naOptions.forEach(n => {
        const option = document.createElement('option');
        option.value = n;
        option.textContent = n;
        if (currentNA === n) option.selected = true;
        naSelectDashboard.appendChild(option);
      });
    }

    function updateDashboardSummary() {
      const year = yearSelectDashboard.value.trim();
      const yearData = electionData.filter(r => r.Year.trim() === year);

      // Aggregate registered voters per district
      const regByDistrict = {};
      yearData.forEach(row => {
        if (row.District) {
          const district = row.District.trim();
          regByDistrict[district] = (regByDistrict[district] || 0) + parseNumber(row['Registered Voters']);
        }
      });

      const totalRegisteredVoters = Object.values(regByDistrict).reduce((a,b) => a + b, 0);
      const totalTurnout = yearData.reduce((sum,row) => sum + parseNumber(row.Votes), 0);
      const turnoutPercent = totalRegisteredVoters > 0 ? (totalTurnout / totalRegisteredVoters) * 100 : 0;
      const numDistricts = Object.keys(regByDistrict).length;

      totalRegisteredVotersSpan.textContent = totalRegisteredVoters.toLocaleString();
      totalTurnoutSpan.textContent = totalTurnout.toLocaleString();
      turnoutPercentSpan.textContent = turnoutPercent.toFixed(2) + '%';
      numDistrictsSpan.textContent = numDistricts;

      updateYearChart();
    }

    function aggregateByYear() {
      const aggregates = {};
      electionData.forEach(row => {
        const y = row.Year ? row.Year.trim() : '';
        const district = row.District ? row.District.trim() : '';
        if (!y || !district) return;

        if (!aggregates[y]) aggregates[y] = { registeredByDistrict: {}, votes: 0 };

        aggregates[y].registeredByDistrict[district] = (aggregates[y].registeredByDistrict[district] || 0) + parseNumber(row['Registered Voters']);
        aggregates[y].votes += parseNumber(row.Votes);
      });

      const yearsSorted = Object.keys(aggregates).sort();
      const regVotersArr = [], votesArr = [];
      yearsSorted.forEach(y => {
        const sumReg = Object.values(aggregates[y].registeredByDistrict).reduce((a, b) => a + b, 0);
        regVotersArr.push(sumReg);
        votesArr.push(aggregates[y].votes);
      });
      return { yearsSorted, regVotersArr, votesArr };
    }

    function updateYearChart() {
      const { yearsSorted, regVotersArr, votesArr } = aggregateByYear();

      if (yearChart) yearChart.destroy();

      yearChart = new Chart(yearChartCtx, {
        type: 'line',
        data: {
          labels: yearsSorted,
          datasets: [
            { label: 'Registered Voters', data: regVotersArr, borderColor: 'blue', fill: false, tension: 0.2 },
            { label: 'Turnout (Votes)', data: votesArr, borderColor: 'green', fill: false, tension: 0.2 },
          ],
        },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            title: { display: true, text: 'Year-wise Registered Voters vs Turnout' },
            tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + ctx.parsed.y.toLocaleString() } }
          },
          scales: {
            y: { beginAtZero: true, ticks: { callback: v => v.toLocaleString() } }
          }
        }
      });
    }

    function updateDistrictAnalysis() {
      const year = yearSelectDashboard.value.trim();
      const selectedDistricts = Array.from(districtsSelectDashboard.selectedOptions).map(o => o.value);
      const selectedNA = naSelectDashboard.value.trim();

      if (selectedDistricts.length === 0) {
        districtAnalysisDiv.innerHTML = '<p>Please select one or more districts to compare.</p>';
        return;
      }

      const filteredRows = electionData.filter(row => {
        if (!row.Year || !row.District) return false;
        if (row.Year.trim() !== year) return false;
        if (!selectedDistricts.includes(row.District.trim())) return false;
        if (selectedNA) {
          return row.NA && row.NA.trim() === selectedNA;
        }
        return true;
      });

      if (filteredRows.length === 0) {
        districtAnalysisDiv.innerHTML = '<p>No data available for the selected filters.</p>';
        return;
      }

      const aggregates = {};
      selectedDistricts.forEach(district => {
        aggregates[district] = { registered: 0, turnout: 0 };
      });

      selectedDistricts.forEach(district => {
        const regSum = filteredRows.filter(r => r.District.trim() === district)
          .reduce((a, r) => a + parseNumber(r['Registered Voters']), 0);
        aggregates[district].registered = regSum;
      });

      filteredRows.forEach(row => {
        const district = row.District.trim();
        if (aggregates[district]) {
          aggregates[district].turnout += parseNumber(row.Votes);
        }
      });

      let html = '<table><thead><tr><th>District</th><th>Registered Voters</th><th>Turnout (Votes)</th><th>Turnout %</th></tr></thead><tbody>';

      selectedDistricts.forEach(district => {
        const reg = aggregates[district].registered;
        const turnout = aggregates[district].turnout;
        const percent = reg > 0 ? (turnout / reg) * 100 : 0;
        html += `<tr>
          <td>${district}</td>
          <td>${reg.toLocaleString()}</td>
          <td>${turnout.toLocaleString()}</td>
          <td>${percent.toFixed(2)}%</td>
        </tr>`;
      });

      html += '</tbody></table>';
      districtAnalysisDiv.innerHTML = html;
    }

    // ------------- RESULTS TAB CODE --------------

    const yearSelectResults = document.getElementById('yearSelectResults');
    const districtSelectResults = document.getElementById('districtSelectResults');
    const naSelectResults = document.getElementById('naSelectResults');
    const summaryResultsDiv = document.getElementById('summaryResults');
    const resultsTable = document.getElementById('resultsTable');
    const resultsTbody = resultsTable.querySelector('tbody');
    const partyChartCtx = document.getElementById('partyChart').getContext('2d');

    let partyChart;

    function initResultsTab() {
      // Populate Year select
      const years = [...new Set(electionData.map(r => r.Year.trim()))].sort();
      yearSelectResults.innerHTML = '';
      years.forEach(y => {
        const option = document.createElement('option');
        option.value = y;
        option.textContent = y;
        yearSelectResults.appendChild(option);
      });

      yearSelectResults.addEventListener('change', () => {
        populateDistrictsResults();
        populateNAResults();
        updateResultsTab();
      });

      districtSelectResults.addEventListener('change', () => {
        populateNAResults();
        updateResultsTab();
      });

      naSelectResults.addEventListener('change', updateResultsTab);

      yearSelectResults.value = years[0];
      populateDistrictsResults();
      populateNAResults();
      updateResultsTab();
    }

    function populateDistrictsResults() {
      const year = yearSelectResults.value.trim();
      const districts = [...new Set(electionData
        .filter(r => r.Year.trim() === year && r.District && r.District.trim() !== '')
        .map(r => r.District.trim())
      )].sort();

      districtSelectResults.innerHTML = '<option value="">-- All Districts --</option>';
      districts.forEach(d => {
        const option = document.createElement('option');
        option.value = d;
        option.textContent = d;
        districtSelectResults.appendChild(option);
      });
      districtSelectResults.value = '';
    }

    function populateNAResults() {
      const year = yearSelectResults.value.trim();
      const district = districtSelectResults.value.trim();
      let nas;

      if (district) {
        nas = [...new Set(electionData
          .filter(r => r.Year.trim() === year && r.District && r.District.trim() === district && r.NA && r.NA.trim() !== '')
          .map(r => r.NA.trim())
        )];
      } else {
        nas = [...new Set(electionData
          .filter(r => r.Year.trim() === year && r.NA && r.NA.trim() !== '')
          .map(r => r.NA.trim())
        )];
      }

      nas.sort();

      naSelectResults.innerHTML = '<option value="">-- All NAs --</option>';
      nas.forEach(n => {
        const option = document.createElement('option');
        option.value = n;
        option.textContent = n;
        naSelectResults.appendChild(option);
      });
      naSelectResults.value = '';
    }

    function updateResultsTab() {
      const year = yearSelectResults.value.trim();
      const district = districtSelectResults.value.trim();
      const na = naSelectResults.value.trim();

      let filtered = electionData.filter(r => r.Year.trim() === year);

      if (district) {
        filtered = filtered.filter(r => r.District && r.District.trim() === district);
      }
      if (na) {
        filtered = filtered.filter(r => r.NA && r.NA.trim() === na);
      }

      if (filtered.length === 0) {
        summaryResultsDiv.innerHTML = '<p>No data available for the selected filters.</p>';
        resultsTable.style.display = 'none';
        if (partyChart) {
          partyChart.destroy();
        }
        partyChartCtx.canvas.style.display = 'none';
        return;
      }

      filtered.sort((a,b) => parseNumber(b.Votes) - parseNumber(a.Votes));

      const winner = filtered[0];
      const winnerVotes = parseNumber(winner.Votes);
      const secondVotes = filtered.length > 1 ? parseNumber(filtered[1].Votes) : 0;
      const margin = winnerVotes - secondVotes;

      summaryResultsDiv.innerHTML = `
        Winner: <strong>${winner['Candidate Name'] || 'N/A'}</strong> (${winner.Party || 'Unknown Party'})<br/>
        Votes: ${winnerVotes.toLocaleString()}<br/>
        Margin of victory: ${margin.toLocaleString()}
      `;

      // Update results table
      resultsTbody.innerHTML = '';
      filtered.forEach(c => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${c['Candidate Name'] || ''}</td>
          <td>${c.Party || ''}</td>
          <td style="text-align:right;">${parseNumber(c.Votes).toLocaleString()}</td>
        `;
        resultsTbody.appendChild(tr);
      });
      resultsTable.style.display = '';

      // Aggregate votes party-wise
      const partyVotes = {};
      filtered.forEach(r => {
        const party = r.Party || 'Independent';
        partyVotes[party] = (partyVotes[party] || 0) + parseNumber(r.Votes);
      });

      const partyLabels = Object.keys(partyVotes).sort((a,b) => partyVotes[b] - partyVotes[a]);
      const partyData = partyLabels.map(p => partyVotes[p]);

      if (partyChart) partyChart.destroy();

      partyChartCtx.canvas.style.display = '';
      partyChart = new Chart(partyChartCtx, {
        type: 'bar',
        data: {
          labels: partyLabels,
          datasets: [{
            label: 'Votes',
            data: partyData,
            backgroundColor: 'rgba(54, 162, 235, 0.7)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: val => val.toLocaleString()
              }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => ctx.parsed.y.toLocaleString() + ' votes'
              }
            }
          }
        }
      });
    }
  </script>
</body>
</html>
