<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Election Dashboard 2024</title>
  <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist-min"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      margin: 20px;
      background-color: #fff;
    }
    .tab-buttons {
      display: flex;
      margin-bottom: 20px;
    }
    .tab-buttons button {
      flex: 1;
      padding: 10px;
      border: none;
      background: #f0f0f0;
      cursor: pointer;
      font-weight: bold;
    }
    .tab-buttons button.active {
      background: #0077b6;
      color: white;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .dropdowns {
      margin: 10px 0;
    }
    select {
      padding: 6px;
      margin-right: 10px;
    }
    #charts-container {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>ðŸ“Š Pakistan Election 2024 - Interactive Dashboard</h1>

  <div class="tab-buttons">
    <button class="tab-btn active" data-tab="districtView">District View</button>
    <button class="tab-btn" data-tab="comparisonView">District Comparison</button>
    <button class="tab-btn" data-tab="provinceOverview">Province Overview</button>
  </div>

  <!-- Tab 1: District View -->
  <div id="districtView" class="tab-content active">
    <div class="dropdowns">
      <label>Select District:</label>
      <select id="districtSelect"></select>
    </div>
    <div id="districtChart"></div>
  </div>

  <!-- Tab 2: District Comparison -->
  <div id="comparisonView" class="tab-content">
    <div class="dropdowns">
      <label>District 1:</label>
      <select id="district1"></select>
      <label>District 2:</label>
      <select id="district2"></select>
    </div>
    <div id="compareChart"></div>
  </div>

  <!-- Tab 3: Province Overview -->
  <div id="provinceOverview" class="tab-content">
    <div id="provinceChart"></div>
    <div id="topDistricts"></div>
  </div>

  <script>
    let data = [];

    // Load CSV
    Papa.parse("data.csv", {
      header: true,
      download: true,
      complete: function(results) {
        data = results.data;
        initializeDashboard();
      }
    });

    function initializeDashboard() {
      const districts = [...new Set(data.map(d => d.District).filter(Boolean))].sort();
      const provinces = [...new Set(data.map(d => d.Province).filter(Boolean))];

      populateSelect("districtSelect", districts);
      populateSelect("district1", districts);
      populateSelect("district2", districts);

      document.getElementById("districtSelect").addEventListener("change", renderDistrictChart);
      document.getElementById("district1").addEventListener("change", renderCompareChart);
      document.getElementById("district2").addEventListener("change", renderCompareChart);

      renderDistrictChart(); // default
      renderCompareChart(); // default
      renderProvinceChart(); // default
    }

    function populateSelect(id, options) {
      const sel = document.getElementById(id);
      sel.innerHTML = options.map(opt => `<option value="${opt}">${opt}</option>`).join("");
    }

    function renderDistrictChart() {
      const district = document.getElementById("districtSelect").value;
      const filtered = data.filter(d => d.District === district && d.Year && d["Registered Voters"]);

      const years = filtered.map(d => d.Year);
      const reg = filtered.map(d => +d["Registered Voters"]);
      const turnout = filtered.map(d => +d["Turnout N"]);
      const pct = turnout.map((t, i) => (reg[i] ? (t / reg[i]) * 100 : 0));

      const traces = [
        { x: years, y: reg, type: 'bar', name: 'Registered Voters' },
        { x: years, y: turnout, type: 'bar', name: 'Voter Turnout' },
        { x: years, y: pct, type: 'line', name: '% Turnout', yaxis: 'y2' }
      ];

      Plotly.newPlot("districtChart", traces, {
        title: `${district} - Year-wise Stats`,
        yaxis: { title: "Count" },
        yaxis2: {
          overlaying: 'y',
          side: 'right',
          title: "% Turnout",
          tickformat: ".1f"
        },
        barmode: "group"
      });
    }

    function renderCompareChart() {
      const d1 = document.getElementById("district1").value;
      const d2 = document.getElementById("district2").value;
      const years = [...new Set(data.map(d => d.Year))].filter(Boolean);

      const getSeries = (district) => {
        const f = data.filter(d => d.District === district && d.Year);
        const byYear = years.map(y => f.find(d => d.Year == y) || {});
        return {
          reg: byYear.map(d => +d["Registered Voters"] || 0),
          turnout: byYear.map(d => +d["Turnout N"] || 0),
          pct: byYear.map((d, i) => d["Registered Voters"] ? (+d["Turnout N"] / +d["Registered Voters"]) * 100 : 0)
        };
      };

      const d1Data = getSeries(d1);
      const d2Data = getSeries(d2);

      const traces = [
        { x: years, y: d1Data.reg, type: "bar", name: `${d1} - Reg` },
        { x: years, y: d2Data.reg, type: "bar", name: `${d2} - Reg` },
        { x: years, y: d1Data.turnout, type: "bar", name: `${d1} - Turnout` },
        { x: years, y: d2Data.turnout, type: "bar", name: `${d2} - Turnout` },
        { x: years, y: d1Data.pct, type: "line", name: `${d1} %`, yaxis: 'y2' },
        { x: years, y: d2Data.pct, type: "line", name: `${d2} %`, yaxis: 'y2' }
      ];

      Plotly.newPlot("compareChart", traces, {
        title: `${d1} vs ${d2} - KPIs`,
        yaxis: { title: "Count" },
        yaxis2: {
          overlaying: 'y',
          side: 'right',
          title: "% Turnout",
          tickformat: ".1f"
        },
        barmode: "group"
      });
    }

    function renderProvinceChart() {
      const filtered = data.filter(d => d.Year == 2024 && d.Province && d["Registered Voters"]);

      const grouped = {};
      filtered.forEach(d => {
        const p = d.Province;
        if (!grouped[p]) grouped[p] = { reg: 0, turnout: 0 };
        grouped[p].reg += +d["Registered Voters"] || 0;
        grouped[p].turnout += +d["Turnout N"] || 0;
      });

      const provinces = Object.keys(grouped);
      const reg = provinces.map(p => grouped[p].reg);
      const turnout = provinces.map(p => grouped[p].turnout);
      const pct = provinces.map((p, i) => (reg[i] ? (turnout[i] / reg[i]) * 100 : 0));

      const traces = [
        { x: provinces, y: reg, type: 'bar', name: 'Registered' },
        { x: provinces, y: turnout, type: 'bar', name: 'Turnout' },
        { x: provinces, y: pct, type: 'line', name: '% Turnout', yaxis: 'y2' }
      ];

      Plotly.newPlot("provinceChart", traces, {
        title: "Province-wise 2024 Overview",
        yaxis: { title: "Count" },
        yaxis2: {
          overlaying: 'y',
          side: 'right',
          title: "% Turnout",
          tickformat: ".1f"
        },
        barmode: "group"
      });

      // Top 3 districts per province
      let html = "";
      provinces.forEach(p => {
        const entries = filtered.filter(d => d.Province === p);
        const sorted = entries.sort((a, b) => (+b["Turnout N"]) - (+a["Turnout N"])).slice(0, 3);
        html += `<h3>${p} - Top 3 Districts (by Turnout)</h3><ul>`;
        sorted.forEach(d => {
          const percent = (+d["Turnout N"] / +d["Registered Voters"]) * 100;
          html += `<li>${d.District}: Reg ${d["Registered Voters"]}, Turnout ${d["Turnout N"]}, % ${percent.toFixed(1)}</li>`;
        });
        html += `</ul>`;
      });

      document.getElementById("topDistricts").innerHTML = html;
    }

    // Tabs functionality
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        const tab = btn.getAttribute("data-tab");
        document.querySelectorAll(".tab-content").forEach(tc => {
          tc.classList.remove("active");
        });
        document.getElementById(tab).classList.add("active");
      });
    });
  </script>
</body>
</html>
