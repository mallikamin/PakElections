<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Election Data Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .summary { margin-bottom: 20px; }
    label, input, select { display: block; margin-top: 10px; }
    select, #districtsSelect, #naSelect {
      margin: 5px 0;
      padding: 5px;
      width: 300px;
    }
    #districtsSelect {
      height: 120px;
    }
    table { border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px 12px; text-align: right; }
    th:first-child, td:first-child { text-align: left; }
    #districtSearch {
      width: 300px;
      padding: 5px;
      margin-top: 5px;
    }
  </style>
</head>
<body>

  <h1>Election Data Dashboard</h1>

  <!-- Year selector -->
  <div>
    <label for="yearSelect">Select Year:</label>
    <select id="yearSelect"></select>
  </div>

  <!-- District search + select -->
  <div>
    <label for="districtSearch">Search District:</label>
    <input type="text" id="districtSearch" placeholder="Type to search district..." autocomplete="off" />
  </div>
  <div>
    <label for="districtsSelect">Select District(s):</label>
    <select id="districtsSelect" multiple></select>
  </div>

  <!-- NA select -->
  <div>
    <label for="naSelect">Select NA (National Assembly constituency):</label>
    <select id="naSelect">
      <option value="">-- All NAs --</option>
    </select>
  </div>

  <!-- Summary Dashboard -->
  <div class="summary">
    <p><strong>Total Registered Voters:</strong> <span id="totalRegisteredVoters">-</span></p>
    <p><strong>Total Turnout (Votes):</strong> <span id="totalTurnout">-</span></p>
    <p><strong>Turnout %:</strong> <span id="turnoutPercent">-</span></p>
    <p><strong>Number of Districts:</strong> <span id="numDistricts">-</span></p>
  </div>

  <!-- Year-wise chart -->
  <canvas id="yearChart" width="800" height="400"></canvas>

  <hr>

  <!-- District-wise analysis -->
  <h2>District-wise Analysis</h2>
  <div id="districtAnalysis"><p>Please select one or more districts to compare.</p></div>

  <script>
    const csvUrl = 'https://raw.githubusercontent.com/mallikamin/PakElections/main/data.csv';

    let electionData = [];
    let years = [];
    let districts = [];

    // Elements
    const yearSelect = document.getElementById('yearSelect');
    const districtSearch = document.getElementById('districtSearch');
    const districtsSelect = document.getElementById('districtsSelect');
    const naSelect = document.getElementById('naSelect');

    const totalRegisteredVotersSpan = document.getElementById('totalRegisteredVoters');
    const totalTurnoutSpan = document.getElementById('totalTurnout');
    const turnoutPercentSpan = document.getElementById('turnoutPercent');
    const numDistrictsSpan = document.getElementById('numDistricts');

    const yearChartCtx = document.getElementById('yearChart').getContext('2d');
    const districtAnalysisDiv = document.getElementById('districtAnalysis');

    let yearChart;

    // Helper: safely parse numbers (handle empty/invalid)
    function parseNumber(val) {
      const num = Number(val);
      return isNaN(num) ? 0 : num;
    }

    // Load CSV and initialize
    Papa.parse(csvUrl, {
      download: true,
      header: true,
      dynamicTyping: false, // parseNumber used explicitly
      complete: (results) => {
        electionData = results.data.filter(row => row.Year && row.Year.trim() !== '');
        initializeUI();
      },
      error: (err) => {
        alert('Error loading CSV: ' + err);
      }
    });

    function initializeUI() {
      // Populate years
      years = [...new Set(electionData.map(r => r.Year.trim()))].sort();
      for (const y of years) {
        const option = document.createElement('option');
        option.value = y;
        option.textContent = y;
        yearSelect.appendChild(option);
      }

      // Populate all districts for first year selected (initially)
      populateDistricts(years[0]);
      populateNASelect();

      // Event listeners
      yearSelect.addEventListener('change', () => {
        const year = yearSelect.value.trim();
        populateDistricts(year);
        populateNASelect();
        districtSearch.value = '';
        districtAnalysisDiv.innerHTML = '<p>Please select one or more districts to compare.</p>';
        // Reset selections
        districtsSelect.selectedIndex = -1;
        naSelect.value = "";

        onYearChange();  // update dashboard + chart
      });

      districtSearch.addEventListener('input', filterDistrictOptions);

      districtsSelect.addEventListener('change', () => {
        populateNASelect();
        onDistrictsChange();
      });

      naSelect.addEventListener('change', onDistrictsChange);

      // Initial update
      yearSelect.value = years[0];
      onYearChange();
    }

    // Populate districts dropdown for a year (all districts appearing in that year)
    function populateDistricts(year) {
      districts = [...new Set(electionData
        .filter(r => r.Year.trim() === year && r.District && r.District.trim() !== '')
        .map(r => r.District.trim())
      )].sort();

      districtsSelect.innerHTML = '';
      for (const d of districts) {
        const option = document.createElement('option');
        option.value = d;
        option.textContent = d;
        districtsSelect.appendChild(option);
      }
    }

    // Filter district options in the multi-select based on search input
    function filterDistrictOptions() {
      const searchTerm = districtSearch.value.trim().toLowerCase();
      const year = yearSelect.value.trim();

      let filtered = districts.filter(d => d.toLowerCase().includes(searchTerm));

      // Preserve selection: save selected options before resetting
      const selectedValues = Array.from(districtsSelect.selectedOptions).map(opt => opt.value);

      districtsSelect.innerHTML = '';
      filtered.forEach(d => {
        const option = document.createElement('option');
        option.value = d;
        option.textContent = d;
        if (selectedValues.includes(d)) {
          option.selected = true;
        }
        districtsSelect.appendChild(option);
      });
    }

    // Populate NA select dropdown filtered for selected Year and selected District(s)
    function populateNASelect() {
      const selectedYear = yearSelect.value.trim();
      const selectedDistricts = Array.from(districtsSelect.selectedOptions).map(opt => opt.value);

      let filteredNAs;

      if (selectedDistricts.length > 0) {
        // Get NAs only for selected districts & year
        filteredNAs = [...new Set(electionData
          .filter(r => r.Year.trim() === selectedYear && r.NA && r.NA.trim() !== '' && selectedDistricts.includes(r.District.trim()))
          .map(r => r.NA.trim())
        )];
      } else {
        // No district selected, show all NAs for the year
        filteredNAs = [...new Set(electionData
          .filter(r => r.Year.trim() === selectedYear && r.NA && r.NA.trim() !== '')
          .map(r => r.NA.trim())
        )];
      }

      filteredNAs.sort();

      // Preserve current selection if still valid
      const currentNA = naSelect.value;

      naSelect.innerHTML = '<option value="">-- All NAs --</option>';
      filteredNAs.forEach(n => {
        const option = document.createElement('option');
        option.value = n;
        option.textContent = n;
        if (currentNA === n) option.selected = true;
        naSelect.appendChild(option);
      });
    }

    // Main dashboard calculations for the selected year
    function onYearChange() {
      const selectedYear = yearSelect.value.trim();

      const yearData = electionData.filter(row => row.Year.trim() === selectedYear);

      // Aggregate Registered Voters per district and sum
      const registeredByDistrict = {};
      yearData.forEach(row => {
        if (row.District) {
          const district = row.District.trim();
          registeredByDistrict[district] = (registeredByDistrict[district] || 0) + parseNumber(row['Registered Voters']);
        }
      });
      const totalRegisteredVoters = Object.values(registeredByDistrict).reduce((a, b) => a + b, 0);

      // Aggregate total Votes
      const totalTurnout = yearData.reduce((sum, row) => sum + parseNumber(row.Votes), 0);

      // Turnout percentage
      const turnoutPercent = totalRegisteredVoters > 0 ? (totalTurnout / totalRegisteredVoters) * 100 : 0;

      const numDistricts = Object.keys(registeredByDistrict).length;

      // Update summary UI
      totalRegisteredVotersSpan.textContent = totalRegisteredVoters.toLocaleString();
      totalTurnoutSpan.textContent = totalTurnout.toLocaleString();
      turnoutPercentSpan.textContent = turnoutPercent.toFixed(2) + '%';
      numDistrictsSpan.textContent = numDistricts;

      updateYearChart();
    }

    // Aggregate year-wise Registered Voters and Votes for chart
    function aggregateByYear() {
      const aggregates = {};

      electionData.forEach(row => {
        const y = row.Year ? row.Year.trim() : '';
        const district = row.District ? row.District.trim() : '';
        if (!y || !district) return;

        if (!aggregates[y]) {
          aggregates[y] = { registeredByDistrict: {}, votes: 0 };
        }

        aggregates[y].registeredByDistrict[district] = (aggregates[y].registeredByDistrict[district] || 0) + parseNumber(row['Registered Voters']);
        aggregates[y].votes += parseNumber(row.Votes);
      });

      const yearsSorted = Object.keys(aggregates).sort();
      const regVotersArr = [];
      const votesArr = [];

      yearsSorted.forEach(y => {
        const regSum = Object.values(aggregates[y].registeredByDistrict).reduce((a,b) => a + b, 0);
        regVotersArr.push(regSum);
        votesArr.push(aggregates[y].votes);
      });

      return { yearsSorted, regVotersArr, votesArr };
    }

    // Draw or update the year-wise chart
    function updateYearChart() {
      const { yearsSorted, regVotersArr, votesArr } = aggregateByYear();

      if (yearChart) yearChart.destroy();

      yearChart = new Chart(yearChartCtx, {
        type: 'line',
        data: {
          labels: yearsSorted,
          datasets: [
            {
              label: 'Registered Voters',
              data: regVotersArr,
              borderColor: 'blue',
              fill: false,
              tension: 0.2,
            },
            {
              label: 'Turnout (Votes)',
              data: votesArr,
              borderColor: 'green',
              fill: false,
              tension: 0.2,
            }
          ]
        },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            title: { display: true, text: 'Year-wise Registered Voters vs Turnout' },
            tooltip: {
              callbacks: {
                label: ctx => ctx.dataset.label + ': ' + ctx.parsed.y.toLocaleString()
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: val => val.toLocaleString()
              }
            }
          }
        }
      });
    }

    // District-wise analysis with District(s) and NA filter
    function onDistrictsChange() {
      const selectedYear = yearSelect.value.trim();
      const selectedDistricts = Array.from(districtsSelect.selectedOptions).map(opt => opt.value);
      const selectedNA = naSelect.value.trim();

      if (selectedDistricts.length === 0) {
        districtAnalysisDiv.innerHTML = '<p>Please select one or more districts to compare.</p>';
        return;
      }

      // Filter for year, districts, and if NA selected, filter NA too
      const filteredData = electionData.filter(row => {
        if (!row.Year || !row.District) return false;
        if (row.Year.trim() !== selectedYear) return false;
        if (!selectedDistricts.includes(row.District.trim())) return false;
        if (selectedNA) {
          return row.NA && row.NA.trim() === selectedNA;
        }
        return true;
      });

      if (filteredData.length === 0) {
        districtAnalysisDiv.innerHTML = '<p>No data available for the selected filters.</p>';
        return;
      }

      const districtAggregates = {};
      selectedDistricts.forEach(district => {
        districtAggregates[district] = { registered: 0, turnout: 0 };
      });

      // Sum Registered Voters per district (filtered rows)
      selectedDistricts.forEach(district => {
        const regSum = filteredData
          .filter(r => r.District.trim() === district)
          .reduce((sum, r) => sum + parseNumber(r['Registered Voters']), 0);
        districtAggregates[district].registered = regSum;
      });

      // Sum turnout per district (Votes)
      filteredData.forEach(row => {
        const district = row.District.trim();
        if (districtAggregates[district]) {
          districtAggregates[district].turnout += parseNumber(row.Votes);
        }
      });

      // Build and display comparison table
      let html = '<table><thead><tr><th>District</th><th>Registered Voters</th><th>Turnout (Votes)</th><th>Turnout %</th></tr></thead><tbody>';

      selectedDistricts.forEach(district => {
        const reg = districtAggregates[district].registered;
        const turnout = districtAggregates[district].turnout;
        const percent = reg > 0 ? (turnout / reg) * 100 : 0;

        html += `<tr>
          <td>${district}</td>
          <td>${reg.toLocaleString()}</td>
          <td>${turnout.toLocaleString()}</td>
          <td>${percent.toFixed(2)}%</td>
        </tr>`;
      });

      html += '</tbody></table>';

      districtAnalysisDiv.innerHTML = html;
    }
  </script>

</body>
</html>
