<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pakistan Election Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 20px auto;
            background: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border-radius: 15px;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #2c5530, #4a7c59);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.8rem;
            font-weight: 300;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }
        
        .year-selector {
            display: inline-block;
            margin-top: 15px;
        }
        
        .year-selector label {
            font-size: 1.1rem;
            margin-right: 15px;
        }
        
        .year-selector select {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 1rem;
            background: white;
            color: #333;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .kpi-section {
            padding: 30px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 20px;
        }
        
        .kpi-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 6px solid;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--card-color), transparent);
        }
        
        .kpi-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        
        .kpi-card.registered { 
            border-left-color: #007bff; 
            --card-color: #007bff;
        }
        .kpi-card.turnout { 
            border-left-color: #28a745; 
            --card-color: #28a745;
        }
        .kpi-card.percentage { 
            border-left-color: #ffc107; 
            --card-color: #ffc107;
        }
        .kpi-card.districts { 
            border-left-color: #6f42c1; 
            --card-color: #6f42c1;
        }
        
        .kpi-value {
            font-size: 2.8rem;
            font-weight: 700;
            color: #2c3e50;
            margin: 15px 0;
            font-family: 'Segoe UI', sans-serif;
        }
        
        .kpi-label {
            font-size: 1rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 600;
        }
        
        .kpi-change {
            font-size: 0.9rem;
            margin-top: 8px;
            opacity: 0.8;
        }
        
        .loading-message {
            text-align: center;
            padding: 60px;
            color: #6c757d;
            font-size: 1.1rem;
        }
        
        .error-message {
            text-align: center;
            padding: 40px;
            color: #dc3545;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            margin: 20px;
        }
        
        .tabs {
            display: flex;
            background: #ffffff;
            border-bottom: 3px solid #dee2e6;
            overflow-x: auto;
        }
        
        .tab {
            padding: 20px 35px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            border-right: 1px solid #dee2e6;
            transition: all 0.3s ease;
            white-space: nowrap;
            color: #495057;
            position: relative;
        }
        
        .tab:hover {
            background: linear-gradient(135deg, #e9ecef, #f8f9fa);
            color: #2c5530;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #2c5530, #4a7c59);
            color: white;
            box-shadow: inset 0 -4px 0 #28a745;
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            right: 0;
            height: 3px;
            background: #28a745;
        }
        
        .tab-content {
            display: none;
            padding: 40px;
            background: #fafbfc;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            margin: 25px 0;
        }
        
        .section-title {
            font-size: 1.8rem;
            color: #2c3e50;
            margin-bottom: 25px;
            font-weight: 600;
        }
        
        canvas {
            max-width: 100%;
            height: 450px !important;
        }
        
        .status-info {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #2196f3;
        }
        
        .status-success {
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            border-left-color: #4caf50;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header h1 {
                font-size: 2.2rem;
            }
            
            .kpi-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1;
                text-align: center;
                min-width: 120px;
            }
            
            .tab-content, .kpi-section {
                padding: 20px;
            }
        }

        /* Loading animation */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4a7c59;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üáµüá∞ Pakistan Election Dashboard</h1>
            <div class="year-selector">
                <label for="yearSelect">Select Year:</label>
                <select id="yearSelect">
                    <option value="">All Years</option>
                </select>
            </div>
        </div>
        
        <div class="kpi-section">
            <div id="kpiContent">
                <div class="loading-message">
                    <div class="spinner"></div>
                    <div>Loading Pakistan Election Data...</div>
                    <div style="font-size: 0.9rem; margin-top: 10px; opacity: 0.7;">
                        Fetching data from data.csv...
                    </div>
                </div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="overview">üèõÔ∏è Overview</div>
            <div class="tab" data-tab="provinces">üó∫Ô∏è Provinces</div>
            <div class="tab" data-tab="analysis">üìä Analysis</div>
            <div class="tab" data-tab="insights">üí° Insights</div>
        </div>

        <div class="tab-content active" id="overview">
            <h2 class="section-title">Electoral Overview</h2>
            <div class="chart-container">
                <canvas id="overviewChart"></canvas>
            </div>
        </div>

        <div class="tab-content" id="provinces">
            <h2 class="section-title">Province-wise Performance</h2>
            <div class="chart-container">
                <canvas id="provinceChart"></canvas>
            </div>
        </div>

        <div class="tab-content" id="analysis">
            <h2 class="section-title">Detailed Analysis</h2>
            <div class="chart-container">
                <canvas id="analysisChart"></canvas>
            </div>
        </div>

        <div class="tab-content" id="insights">
            <h2 class="section-title">Key Insights</h2>
            <div id="insightsContent">
                <div class="loading-message">Analysis will appear here once data is loaded...</div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let allData = [];
        let filteredData = [];
        let charts = {};
        let selectedYear = '';

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Pakistan Election Dashboard Starting...');
            initializeTabs();
            loadElectionData();
        });

        // Tab functionality
        function initializeTabs() {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs and contents
                    tabs.forEach(t => t.classList.remove('active'));
                    contents.forEach(c => c.classList.remove('active'));

                    // Add active class to clicked tab and corresponding content
                    tab.classList.add('active');
                    const targetContent = document.getElementById(tab.dataset.tab);
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }
                });
            });
        }

        // Enhanced number formatting
        function formatNumber(num) {
            if (num == null || isNaN(num)) return '0';
            
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(0) + 'K';
            }
            return Math.round(num).toLocaleString();
        }

        // Robust number parsing
        function parseNumber(value) {
            if (value == null || value === '') return 0;
            
            // Convert to string and clean
            const cleaned = value.toString()
                .trim()
                .replace(/[,\s]/g, '')
                .replace(/[^\d.-]/g, '');
                
            const parsed = parseFloat(cleaned);
            return isNaN(parsed) ? 0 : Math.round(parsed);
        }

        // Load election data with multiple strategies
        async function loadElectionData() {
            console.log('üìä Loading election data...');
            
            try {
                // Strategy 1: Direct CSV load
                await loadCSVData();
            } catch (error) {
                console.warn('CSV loading failed, using sample data:', error);
                useSampleData();
            }
        }

        // Load CSV data using PapaParse
        function loadCSVData() {
            return new Promise((resolve, reject) => {
                Papa.parse('./data.csv', {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: false,
                    complete: function(results) {
                        console.log('üìÅ CSV parsing complete:', results);
                        
                        if (results.errors && results.errors.length > 0) {
                            console.warn('CSV parsing errors:', results.errors);
                        }
                        
                        if (results.data && results.data.length > 0) {
                            console.log('‚úÖ Valid CSV data found!');
                            console.log('Headers:', Object.keys(results.data[0]));
                            console.log('Sample rows:', results.data.slice(0, 3));
                            
                            processElectionData(results.data);
                            resolve();
                        } else {
                            reject(new Error('Empty or invalid CSV data'));
                        }
                    },
                    error: function(error) {
                        console.error('‚ùå Papa Parse error:', error);
                        reject(error);
                    }
                });
            });
        }

        // Generate realistic sample data if CSV fails
        function useSampleData() {
            console.log('üìã Using sample election data...');
            
            const sampleData = generateSampleElectionData();
            processElectionData(sampleData);
            
            // Show sample data notice
            showMessage('Using sample data for demonstration. Please ensure data.csv is accessible.', 'info');
        }

        function generateSampleElectionData() {
            const provinces = [
                { name: 'Punjab', constituencies: 141, baseVoters: 73000000 },
                { name: 'Sindh', constituencies: 61, baseVoters: 26000000 },
                { name: 'Khyber Pakhtunkhwa', constituencies: 45, baseVoters: 21000000 },
                { name: 'Balochistan', constituencies: 16, baseVoters: 5000000 },
                { name: 'Islamabad', constituencies: 3, baseVoters: 700000 },
                { name: 'FATA', constituencies: 12, baseVoters: 2800000 }
            ];

            const years = ['2018', '2024'];
            const data = [];

            provinces.forEach(province => {
                const votersPerConstituency = Math.floor(province.baseVoters / province.constituencies);
                
                for (let i = 1; i <= province.constituencies; i++) {
                    years.forEach(year => {
                        const registeredVoters = Math.floor(votersPerConstituency * (0.85 + Math.random() * 0.3));
                        const turnoutRate = year === '2024' ? 
                            (0.40 + Math.random() * 0.35) : // 2024: 40-75%
                            (0.35 + Math.random() * 0.30); // 2018: 35-65%
                        const actualVoters = Math.floor(registeredVoters * turnoutRate);
                        
                        data.push({
                            Year: year,
                            Province: province.name,
                            District: `${province.name}-${i.toString().padStart(3, '0')}`,
                            Constituency: `NA-${(data.length + 1).toString().padStart(3, '0')}`,
                            RegisteredVoters: registeredVoters,
                            Voters: actualVoters,
                            TurnoutPct: (actualVoters / registeredVoters * 100).toFixed(2)
                        });
                    });
                }
            });

            console.log('Generated sample data:', data.length, 'records');
            return data;
        }

        // Process and clean election data
        function processElectionData(rawData) {
            console.log('üîÑ Processing election data...');
            console.log('Raw data rows:', rawData.length);

            // Clean and standardize data
            allData = rawData
                .filter(row => {
                    // Check for essential columns with various naming conventions
                    const hasYear = row.Year || row.year || row.YEAR;
                    const hasProvince = row.Province || row.province || row.PROVINCE;
                    const hasVoters = row.Voters || row.voters || row.VOTERS || row.Turnout || row.turnout;
                    const hasRegistered = row.RegisteredVoters || row['Registered Voters'] || row.registered_voters;
                    
                    return hasYear && hasProvince && (hasVoters || hasRegistered);
                })
                .map(row => {
                    // Standardize column names and parse numbers
                    const year = (row.Year || row.year || row.YEAR || '2024').toString();
                    const province = (row.Province || row.province || row.PROVINCE || '').trim();
                    const district = (row.District || row.district || row.DISTRICT || province).trim();
                    
                    const registeredVoters = parseNumber(
                        row.RegisteredVoters || row['Registered Voters'] || row.registered_voters || 
                        row.REGISTERED_VOTERS || 0
                    );
                    
                    const actualVoters = parseNumber(
                        row.Voters || row.voters || row.VOTERS || row.Turnout || row.turnout || 
                        row.TURNOUT || 0
                    );
                    
                    return {
                        Year: year,
                        Province: province,
                        District: district,
                        RegisteredVoters: registeredVoters,
                        Voters: actualVoters,
                        TurnoutPct: registeredVoters > 0 ? (actualVoters / registeredVoters * 100) : 0
                    };
                })
                .filter(row => 
                    row.Year && 
                    row.Province && 
                    (row.RegisteredVoters > 0 || row.Voters > 0)
                );

            console.log('‚úÖ Processed data:', allData.length, 'valid records');
            
            if (allData.length === 0) {
                showMessage('No valid data found in CSV. Using sample data.', 'warning');
                useSampleData();
                return;
            }

            // Calculate verification totals
            const total2024 = allData
                .filter(row => row.Year === '2024')
                .reduce((sum, row) => sum + row.Voters, 0);
            
            console.log('üìä 2024 Total Voters:', total2024.toLocaleString());

            // Initialize dashboard
            setupYearSelector();
            updateDashboard();
            showMessage(`Successfully loaded ${allData.length} election records!`, 'success');
        }

        // Setup year selector dropdown
        function setupYearSelector() {
            const years = [...new Set(allData.map(row => row.Year))].sort().reverse();
            const yearSelect = document.getElementById('yearSelect');
            
            // Clear existing options except "All Years"
            yearSelect.innerHTML = '<option value="">All Years</option>';
            
            // Add year options
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
            
            // Set default to most recent year
            selectedYear = years[0] || '';
            yearSelect.value = selectedYear;
            
            // Add change event listener
            yearSelect.addEventListener('change', function() {
                selectedYear = this.value;
                updateDashboard();
            });
        }

        // Update entire dashboard
        function updateDashboard() {
            filterData();
            renderKPIs();
            renderCharts();
            renderInsights();
        }

        // Filter data based on selected year
        function filterData() {
            if (selectedYear === '') {
                filteredData = [...allData];
            } else {
                filteredData = allData.filter(row => row.Year === selectedYear);
            }
            
            console.log(`üìà Filtered data for ${selectedYear || 'All Years'}: ${filteredData.length} records`);
        }

        // Render KPI cards
        function renderKPIs() {
            console.log('üìä Rendering KPIs...');
            
            // Calculate totals using direct summation
            const totalRegistered = filteredData.reduce((sum, row) => sum + row.RegisteredVoters, 0);
            const totalVoters = filteredData.reduce((sum, row) => sum + row.Voters, 0);
            const overallTurnout = totalRegistered > 0 ? (totalVoters / totalRegistered * 100) : 0;
            const uniqueDistricts = new Set(filteredData.map(row => row.District)).size;
            
            console.log('KPI Calculations:');
            console.log('- Registered:', totalRegistered.toLocaleString());
            console.log('- Voters:', totalVoters.toLocaleString());
            console.log('- Turnout:', overallTurnout.toFixed(2) + '%');
            console.log('- Districts:', uniqueDistricts);

            const kpiHTML = `
                <div class="kpi-grid">
                    <div class="kpi-card registered">
                        <div class="kpi-value">${formatNumber(totalRegistered)}</div>
                        <div class="kpi-label">Registered Voters</div>
                        <div class="kpi-change">Total eligible voters</div>
                    </div>
                    <div class="kpi-card turnout">
                        <div class="kpi-value">${formatNumber(totalVoters)}</div>
                        <div class="kpi-label">Total Turnout</div>
                        <div class="kpi-change">Actual votes cast</div>
                    </div>
                    <div class="kpi-card percentage">
                        <div class="kpi-value">${overallTurnout.toFixed(1)}%</div>
                        <div class="kpi-label">Turnout Rate</div>
                        <div class="kpi-change">Overall participation</div>
                    </div>
                    <div class="kpi-card districts">
                        <div class="kpi-value">${uniqueDistricts}</div>
                        <div class="kpi-label">Districts</div>
                        <div class="kpi-change">Electoral units</div>
                    </div>
                </div>
            `;

            document.getElementById('kpiContent').innerHTML = kpiHTML;
        }

        // Render all charts
        function renderCharts() {
            renderOverviewChart();
            renderProvinceChart();
            renderAnalysisChart();
        }

        // Overview chart
        function renderOverviewChart() {
            const ctx = document.getElementById('overviewChart').getContext('2d');
            
            if (charts.overview) {
                charts.overview.destroy();
            }

            // Aggregate by year
            const yearData = {};
            filteredData.forEach(row => {
                if (!yearData[row.Year]) {
                    yearData[row.Year] = { registered: 0, voters: 0 };
                }
                yearData[row.Year].registered += row.RegisteredVoters;
                yearData[row.Year].voters += row.Voters;
            });

            const years = Object.keys(yearData).sort();
            const registeredData = years.map(year => yearData[year].registered / 1000000);
            const votersData = years.map(year => yearData[year].voters / 1000000);
            const turnoutData = years.map(year => 
                yearData[year].registered > 0 ? 
                (yearData[year].voters / yearData[year].registered * 100) : 0
            );

            charts.overview = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: 'Registered Voters (Millions)',
                            data: registeredData,
                            backgroundColor: 'rgba(0, 123, 255, 0.8)',
                            borderColor: 'rgba(0, 123, 255, 1)',
                            borderWidth: 2,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Actual Turnout (Millions)',
                            data: votersData,
                            backgroundColor: 'rgba(40, 167, 69, 0.8)',
                            borderColor: 'rgba(40, 167, 69, 1)',
                            borderWidth: 2,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Turnout Rate (%)',
                            data: turnoutData,
                            type: 'line',
                            borderColor: '#ffc107',
                            backgroundColor: '#ffc107',
                            borderWidth: 3,
                            fill: false,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Election Overview ${selectedYear ? '(' + selectedYear + ')' : '(All Years)'}`,
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            title: { display: true, text: 'Voters (Millions)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: 'Turnout Rate (%)' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        // Province chart
        function renderProvinceChart() {
            const ctx = document.getElementById('provinceChart').getContext('2d');
            
            if (charts.province) {
                charts.province.destroy();
            }

            // Aggregate by province
            const provinceData = {};
            filteredData.forEach(row => {
                if (!provinceData[row.Province]) {
                    provinceData[row.Province] = { registered: 0, voters: 0 };
                }
                provinceData[row.Province].registered += row.RegisteredVoters;
                provinceData[row.Province].voters += row.Voters;
            });

            const provinces = Object.keys(provinceData);
            const registeredData = provinces.map(p => provinceData[p].registered / 1000000);
            const votersData = provinces.map(p => provinceData[p].voters / 1000000);
            const turnoutData = provinces.map(p => 
                provinceData[p].registered > 0 ? 
                (provinceData[p].voters / provinceData[p].registered * 100) : 0
            );

            charts.province = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: provinces,
                    datasets: [
                        {
                            label: 'Registered (M)',
                            data: registeredData,
                            backgroundColor: 'rgba(54, 162, 235, 0.8)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2
                        },
                        {
                            label: 'Turnout (M)',
                            data: votersData,
                            backgroundColor: 'rgba(75, 192, 192, 0.8)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Provincial Performance ${selectedYear ? '(' + selectedYear + ')' : '(All Years)'}`,
                            font: { size: 16, weight: 'bold' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Voters (Millions)' }
                        }
                    }
                }
            });
        }

        // Analysis chart (turnout distribution)
        function renderAnalysisChart() {
            const ctx = document.getElementById('analysisChart').getContext('2d');
            
            if (charts.analysis) {
                charts.analysis.destroy();
            }

            // Calculate turnout distribution
            const turnoutRanges = [
                { min: 0, max: 25, label: 'Very Low (0-25%)', color: '#dc3545' },
                { min: 25, max: 50, label: 'Low (25-50%)', color: '#fd7e14' },
                { min: 50, max: 70, label: 'Moderate (50-70%)', color: '#ffc107' },
                { min: 70, max: 100, label: 'High (70%+)', color: '#28a745' }
            ];

            const districtTurnouts = {};
            filteredData.forEach(row => {
                if (!districtTurnouts[row.District]) {
                    districtTurnouts[row.District] = { registered: 0, voters: 0 };
                }
                districtTurnouts[row.District].registered += row.RegisteredVoters;
                districtTurnouts[row.District].voters += row.Voters;
            });

            const turnoutPercentages = Object.values(districtTurnouts).map(district => 
                district.registered > 0 ? (district.voters / district.registered * 100) : 0
            );

            const distributionData = turnoutRanges.map(range => {
                const count = turnoutPercentages.filter(turnout => 
                    turnout >= range.min && turnout < range.max
                ).length;
                return { label: range.label, count, color: range.color };
            });

            charts.analysis = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: distributionData.map(d => d.label),
                    datasets: [{
                        data: distributionData.map(d => d.count),
                        backgroundColor: distributionData.map(d => d.color),
                        borderWidth: 3,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Turnout Distribution Analysis ${selectedYear ? '(' + selectedYear + ')' : '(All Years)'}`,
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: { position: 'right' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.raw / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.raw} districts (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Render insights
        function renderInsights() {
            const totalRegistered = filteredData.reduce((sum, row) => sum + row.RegisteredVoters, 0);
            const totalVoters = filteredData.reduce((sum, row) => sum + row.Voters, 0);
            const overallTurnout = totalRegistered > 0 ? (totalVoters / totalRegistered * 100) : 0;
            const uniqueProvinces = new Set(filteredData.map(row => row.Province)).size;
            const uniqueDistricts = new Set(filteredData.map(row => row.District)).size;

            // Calculate provincial performance
            const provinceStats = {};
            filteredData.forEach(row => {
                if (!provinceStats[row.Province]) {
                    provinceStats[row.Province] = { registered: 0, voters: 0 };
                }
                provinceStats[row.Province].registered += row.RegisteredVoters;
                provinceStats[row.Province].voters += row.Voters;
            });

            const provincePerformance = Object.entries(provinceStats)
                .map(([province, stats]) => ({
                    province,
                    turnout: stats.registered > 0 ? (stats.voters / stats.registered * 100) : 0,
                    voters: stats.voters,
                    registered: stats.registered
                }))
                .sort((a, b) => b.turnout - a.turnout);

            const highestTurnout = provincePerformance[0];
            const lowestTurnout = provincePerformance[provincePerformance.length - 1];

            const insightsHTML = `
                <div class="chart-container">
                    <h3 style="color: #2c5530; margin-bottom: 25px;">üìä Key Electoral Insights</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-bottom: 30px;">
                        <div style="background: linear-gradient(135deg, #e8f5e8, #c8e6c9); padding: 20px; border-radius: 10px; border-left: 5px solid #4caf50;">
                            <h4 style="color: #2e7d32; margin-bottom: 10px;">üèÜ Best Performing Province</h4>
                            <div style="font-size: 1.2rem; font-weight: bold; color: #1b5e20;">${highestTurnout?.province || 'N/A'}</div>
                            <div style="color: #388e3c;">${highestTurnout?.turnout.toFixed(1) || 0}% turnout</div>
                            <div style="font-size: 0.9rem; color: #4caf50; margin-top: 5px;">
                                ${formatNumber(highestTurnout?.voters || 0)} of ${formatNumber(highestTurnout?.registered || 0)} voters
                            </div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #fff3e0, #ffcc02); padding: 20px; border-radius: 10px; border-left: 5px solid #ff9800;">
                            <h4 style="color: #ef6c00; margin-bottom: 10px;">üìà National Average</h4>
                            <div style="font-size: 1.2rem; font-weight: bold; color: #e65100;">${overallTurnout.toFixed(1)}%</div>
                            <div style="color: #f57c00;">Overall turnout rate</div>
                            <div style="font-size: 0.9rem; color: #ff9800; margin-top: 5px;">
                                ${formatNumber(totalVoters)} total votes cast
                            </div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #e1f5fe, #81d4fa); padding: 20px; border-radius: 10px; border-left: 5px solid #03a9f4;">
                            <h4 style="color: #0277bd; margin-bottom: 10px;">üó≥Ô∏è Electoral Scale</h4>
                            <div style="font-size: 1.2rem; font-weight: bold; color: #01579b;">${uniqueDistricts}</div>
                            <div style="color: #0288d1;">Districts covered</div>
                            <div style="font-size: 0.9rem; color: #03a9f4; margin-top: 5px;">
                                Across ${uniqueProvinces} provinces
                            </div>
                        </div>
                    </div>

                    <div style="background: #f8f9fa; padding: 25px; border-radius: 10px; margin-bottom: 25px;">
                        <h4 style="color: #2c5530; margin-bottom: 15px;">üîç Provincial Performance Ranking</h4>
                        <div style="display: grid; gap: 12px;">
                            ${provincePerformance.map((province, index) => `
                                <div style="display: flex; justify-content: between; align-items: center; padding: 12px; background: white; border-radius: 8px; border-left: 4px solid ${index === 0 ? '#4caf50' : index === provincePerformance.length - 1 ? '#f44336' : '#2196f3'};">
                                    <div style="flex: 1;">
                                        <strong style="color: #2c3e50;">${province.province}</strong>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 1.1rem; font-weight: bold; color: #2c5530;">${province.turnout.toFixed(1)}%</div>
                                        <div style="font-size: 0.85rem; color: #6c757d;">${formatNumber(province.voters)} voters</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 20px; border-radius: 10px; border-left: 5px solid #2196f3;">
                        <h4 style="color: #1976d2; margin-bottom: 15px;">üìä Summary Statistics ${selectedYear ? '(' + selectedYear + ')' : '(All Years)'}</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div>
                                <div style="font-weight: bold; color: #1565c0;">Total Registered Voters</div>
                                <div style="font-size: 1.2rem; color: #0d47a1;">${formatNumber(totalRegistered)}</div>
                            </div>
                            <div>
                                <div style="font-weight: bold; color: #1565c0;">Actual Voter Turnout</div>
                                <div style="font-size: 1.2rem; color: #0d47a1;">${formatNumber(totalVoters)}</div>
                            </div>
                            <div>
                                <div style="font-weight: bold; color: #1565c0;">Overall Turnout Rate</div>
                                <div style="font-size: 1.2rem; color: #0d47a1;">${overallTurnout.toFixed(2)}%</div>
                            </div>
                            <div>
                                <div style="font-weight: bold; color: #1565c0;">Data Records</div>
                                <div style="font-size: 1.2rem; color: #0d47a1;">${filteredData.length.toLocaleString()}</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding: 10px; background: rgba(255, 255, 255, 0.7); border-radius: 6px; font-size: 0.9rem; color: #1565c0;">
                            <strong>üìà Calculation Method:</strong> Direct summation of all constituency-level data. 
                            Each record contributes to the total turnout calculation: 
                            Œ£(Voters) √∑ Œ£(RegisteredVoters) √ó 100 = ${overallTurnout.toFixed(2)}%
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('insightsContent').innerHTML = insightsHTML;
        }

        // Utility function to show messages
        function showMessage(text, type = 'info') {
            const messageClass = type === 'success' ? 'status-success' : 'status-info';
            const statusDiv = document.createElement('div');
            statusDiv.className = `status-info ${messageClass}`;
            statusDiv.innerHTML = `
                <strong>${type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</strong> ${text}
            `;
            
            // Add to KPI section temporarily
            const kpiSection = document.getElementById('kpiContent');
            kpiSection.appendChild(statusDiv);
            
            // Remove after 5 seconds
            setTimeout(() => {
                if (statusDiv.parentNode) {
                    statusDiv.parentNode.removeChild(statusDiv);
                }
            }, 5000);
        }

        // Error handling for chart creation
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Dashboard Error:', {
                message: msg,
                source: url,
                line: lineNo,
                column: columnNo,
                error: error
            });
            
            showMessage('An error occurred while loading the dashboard. Please check the console for details.', 'warning');
            return false;
        };

        console.log('üéØ Pakistan Election Dashboard Initialized Successfully!');
    </script>
</body>
</html>
