<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pakistan Election Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border-radius: 15px;
            overflow: hidden;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        
        .header {
            background: linear-gradient(45deg, #2c5530, #4a7c59);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 300;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 25px;
            background: #f8f9fa;
        }
        
        .kpi-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 5px solid;
            transition: transform 0.3s ease;
        }
        
        .kpi-card:hover {
            transform: translateY(-5px);
        }
        
        .kpi-card.voters { border-left-color: #007bff; }
        .kpi-card.turnout { border-left-color: #28a745; }
        .kpi-card.percentage { border-left-color: #ffc107; }
        .kpi-card.districts { border-left-color: #6f42c1; }
        
        .kpi-value {
            font-size: 2.2rem;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
        }
        
        .kpi-label {
            font-size: 0.9rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .tabs {
            display: flex;
            background-color: #ffffff;
            border-bottom: 3px solid #dee2e6;
            overflow-x: auto;
        }
        
        .tab {
            padding: 18px 30px;
            cursor: pointer;
            font-weight: 600;
            border-right: 1px solid #dee2e6;
            transition: all 0.3s ease;
            white-space: nowrap;
            color: #495057;
        }
        
        .tab:hover {
            background-color: #e9ecef;
        }
        
        .tab.active {
            background: linear-gradient(45deg, #2c5530, #4a7c59);
            color: white;
            box-shadow: inset 0 -3px 0 #28a745;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        
        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .control-group label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }
        
        select {
            padding: 12px 16px;
            font-size: 16px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            background: white;
            transition: border-color 0.3s ease;
            min-width: 200px;
        }
        
        select:focus {
            outline: none;
            border-color: #4a7c59;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 5px;
        }
        
        canvas {
            max-width: 100%;
            height: 400px !important;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            select {
                min-width: unset;
            }
            
            .kpi-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üáµüá∞ Pakistan Election Dashboard</h1>
            <div style="margin-top: 15px;">
                <label for="yearSelect" style="color: white; font-size: 1.1rem; margin-right: 10px;">Select Year:</label>
                <select id="yearSelect" style="padding: 8px 15px; border-radius: 5px; border: none; font-size: 1rem;">
                    <option value="">All Years</option>
                </select>
            </div>
        </div>
        
        <div class="kpi-grid" id="kpiSection">
            <div class="loading">Loading election data...</div>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="province">üèõÔ∏è Province Overview</div>
            <div class="tab" data-tab="district">üèôÔ∏è District Analysis</div>
            <div class="tab" data-tab="compare">‚öñÔ∏è District Comparison</div>
            <div class="tab" data-tab="trends">üìä Engagement Trends</div>
        </div>

        <div class="tab-content active" id="province">
            <h2>Province-wise Electoral Performance</h2>
            <div class="chart-container">
                <canvas id="provinceChart"></canvas>
            </div>
        </div>

        <div class="tab-content" id="district">
            <h2>District-level Analysis</h2>
            <div class="controls">
                <div class="control-group">
                    <label for="districtSelect">Select District:</label>
                    <select id="districtSelect">
                        <option value="">Choose a district...</option>
                    </select>
                </div>
            </div>
            <div class="stats-grid" id="districtStats" style="display: none;"></div>
            <div class="chart-container">
                <canvas id="districtChart"></canvas>
            </div>
        </div>

        <div class="tab-content" id="compare">
            <h2>District Comparison Analysis</h2>
            <div class="controls">
                <div class="control-group">
                    <label for="compare1">First District:</label>
                    <select id="compare1">
                        <option value="">Choose first district...</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="compare2">Second District:</label>
                    <select id="compare2">
                        <option value="">Choose second district...</option>
                    </select>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="compareChart"></canvas>
            </div>
        </div>

        <div class="tab-content" id="trends">
            <h2>Voter Engagement Analysis</h2>
            <div class="chart-container">
                <canvas id="trendsChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let allData = [];
        let data = [];
        let charts = {};
        let selectedYear = '';

        // Initialize tabs
        const tabs = document.querySelectorAll('.tab');
        const contents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                contents.forEach(c => c.classList.remove('active'));

                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });

        // Utility functions
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toLocaleString();
        }

        function parseNumberSafe(str) {
            const cleaned = str ? str.toString().replace(/[^\d.-]/g, '') : '0';
            const num = parseFloat(cleaned);
            return isNaN(num) ? 0 : num;
        }

        function calculateTurnoutRate(turnout, registered) {
            return registered > 0 ? (turnout / registered * 100) : 0;
        }

        // Generate sample data for demo
        function generateSampleData() {
            const provinces = ['Punjab', 'Sindh', 'Khyber Pakhtunkhwa', 'Balochistan', 'Gilgit-Baltistan'];
            const years = ['2018', '2024'];
            const sampleData = [];

            provinces.forEach(province => {
                const districtCount = province === 'Punjab' ? 10 : province === 'Sindh' ? 8 : 6;
                
                for (let i = 1; i <= districtCount; i++) {
                    years.forEach(year => {
                        const baseVoters = Math.floor(Math.random() * 500000) + 200000;
                        const turnoutRate = Math.random() * 0.4 + 0.3; // 30-70%
                        const actualTurnout = Math.floor(baseVoters * turnoutRate);
                        
                        sampleData.push({
                            Province: province,
                            District: `${province} District ${i}`,
                            Year: year,
                            RegisteredVoters: baseVoters,
                            Voters: actualTurnout,
                            TurnoutN: actualTurnout,
                            TurnoutPct: turnoutRate * 100
                        });
                    });
                }
            });

            return sampleData;
        }

        // Load and process data
        function loadData() {
            // Try to load from CSV first, fallback to sample data
            Papa.parse("data.csv", {
                header: true,
                download: true,
                skipEmptyLines: true,
                dynamicTyping: false,
                complete: function(results) {
                    if (results.data && results.data.length > 0) {
                        processData(results.data);
                    } else {
                        console.log("No CSV data found, using sample data");
                        processData(generateSampleData());
                    }
                },
                error: function(error) {
                    console.log("CSV not found, using sample data");
                    processData(generateSampleData());
                }
            });
        }

        function processData(rawData) {
            console.log("Raw data loaded:", rawData.length, "rows");
            
            // Process all data first
            allData = rawData
                .filter(row => row.RegisteredVoters || row["Registered Voters"] || row.registered_voters)
                .map(row => {
                    // Normalize column names and parse numbers
                    const normalized = {
                        Province: row.Province || row.province || '',
                        District: row.District || row.district || '',
                        Year: row.Year || row.year || '2024',
                        RegisteredVoters: parseNumberSafe(row.RegisteredVoters || row["Registered Voters"] || row.registered_voters),
                        Voters: parseNumberSafe(row.Voters || row.voters || 0),
                        TurnoutN: parseNumberSafe(row.TurnoutN || row["Turnout N"] || row.turnout_n || row.Voters || row.voters),
                        TurnoutPct: 0
                    };
                    
                    // Use "Voters" column as the actual turnout if available, otherwise use TurnoutN
                    const actualTurnout = parseNumberSafe(row.Voters || row.voters) || normalized.TurnoutN;
                    normalized.TurnoutN = actualTurnout;
                    
                    // Calculate turnout percentage correctly
                    if (normalized.RegisteredVoters > 0) {
                        normalized.TurnoutPct = (actualTurnout / normalized.RegisteredVoters * 100);
                    }
                    
                    return normalized;
                })
                .filter(row => row.RegisteredVoters > 0);

            console.log("Processed all data:", allData.length, "rows");
            
            if (allData.length === 0) {
                document.getElementById('kpiSection').innerHTML = 
                    '<div style="text-align: center; color: #dc3545; padding: 40px;">No valid election data found. Using sample data for demonstration.</div>';
                allData = generateSampleData();
            }

            // Populate year dropdown
            const years = [...new Set(allData.map(row => row.Year))].sort().reverse();
            const yearSelect = document.getElementById('yearSelect');
            yearSelect.innerHTML = '<option value="">All Years</option>';
            years.forEach(year => {
                yearSelect.add(new Option(year, year));
            });
            
            // Set default to latest year
            selectedYear = years[0];
            yearSelect.value = selectedYear;
            
            // Add year selection handler
            yearSelect.addEventListener('change', () => {
                selectedYear = yearSelect.value;
                filterDataByYear();
                updateAllVisualizations();
            });

            // Initial load with latest year
            filterDataByYear();
            updateAllVisualizations();
        }

        function filterDataByYear() {
            if (selectedYear === '') {
                data = [...allData];
            } else {
                data = allData.filter(row => row.Year === selectedYear);
            }
            console.log(`Filtered data for year ${selectedYear}:`, data.length, "rows");
        }

        function updateAllVisualizations() {
            renderKPIs();
            renderProvinceChart();
            populateDistrictDropdowns();
            renderTrendsChart();
        }

        function renderKPIs() {
            const totalVoters = data.reduce((sum, row) => sum + row.RegisteredVoters, 0);
            const totalTurnout = data.reduce((sum, row) => sum + row.TurnoutN, 0);
            const avgTurnoutPct = data.length > 0 ? 
                (data.reduce((sum, row) => sum + row.TurnoutPct, 0) / data.length) : 0;
            const totalDistricts = new Set(data.map(row => row.District)).size;

            document.getElementById('kpiSection').innerHTML = `
                <div class="kpi-card voters">
                    <div class="kpi-value">${formatNumber(totalVoters)}</div>
                    <div class="kpi-label">Total Registered Voters</div>
                </div>
                <div class="kpi-card turnout">
                    <div class="kpi-value">${formatNumber(totalTurnout)}</div>
                    <div class="kpi-label">Total Voter Turnout</div>
                </div>
                <div class="kpi-card percentage">
                    <div class="kpi-value">${avgTurnoutPct.toFixed(1)}%</div>
                    <div class="kpi-label">Average Turnout Rate</div>
                </div>
                <div class="kpi-card districts">
                    <div class="kpi-value">${totalDistricts}</div>
                    <div class="kpi-label">Total Districts</div>
                </div>
            `;
        }

        function renderProvinceChart() {
            const provinces = [...new Set(data.map(row => row.Province))].filter(p => p);
            const provinceData = provinces.map(province => {
                const rows = data.filter(r => r.Province === province);
                const totalVoters = rows.reduce((sum, r) => sum + r.RegisteredVoters, 0);
                const totalTurnout = rows.reduce((sum, r) => sum + r.TurnoutN, 0);
                const avgTurnoutPct = rows.length > 0 ? 
                    (rows.reduce((sum, r) => sum + r.TurnoutPct, 0) / rows.length) : 0;
                
                return {
                    province,
                    totalVoters: totalVoters / 1000000,
                    totalTurnout: totalTurnout / 1000000,
                    turnoutPct: avgTurnoutPct
                };
            });

            // Destroy existing chart
            if (charts.provinceChart) {
                charts.provinceChart.destroy();
            }

            const ctx = document.getElementById("provinceChart").getContext("2d");
            charts.provinceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: provinceData.map(d => d.province),
                    datasets: [
                        {
                            label: 'Registered Voters (Millions)',
                            data: provinceData.map(d => d.totalVoters),
                            backgroundColor: 'rgba(0, 123, 255, 0.8)',
                            borderColor: 'rgba(0, 123, 255, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Voter Turnout (Millions)',
                            data: provinceData.map(d => d.totalTurnout),
                            backgroundColor: 'rgba(40, 167, 69, 0.8)',
                            borderColor: 'rgba(40, 167, 69, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Turnout Rate (%)',
                            data: provinceData.map(d => d.turnoutPct),
                            backgroundColor: 'rgba(255, 193, 7, 0.8)',
                            borderColor: 'rgba(255, 193, 7, 1)',
                            borderWidth: 1,
                            type: 'line',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `Provincial Electoral Statistics ${selectedYear ? '(' + selectedYear + ')' : ''}`
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Voters (Millions)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Turnout Rate (%)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }

        function populateDistrictDropdowns() {
            const districts = [...new Set(data.map(row => row.District))].filter(d => d).sort();
            const districtSelect = document.getElementById("districtSelect");
            const compare1 = document.getElementById("compare1");
            const compare2 = document.getElementById("compare2");

            // Clear existing options except first one
            [districtSelect, compare1, compare2].forEach(select => {
                while (select.children.length > 1) {
                    select.removeChild(select.lastChild);
                }
            });

            // Populate dropdowns
            districts.forEach(district => {
                districtSelect.add(new Option(district, district));
                compare1.add(new Option(district, district));
                compare2.add(new Option(district, district));
            });

            // District selection handler
            districtSelect.addEventListener('change', handleDistrictSelection);

            // Comparison handlers
            compare1.addEventListener('change', updateComparison);
            compare2.addEventListener('change', updateComparison);
        }

        function handleDistrictSelection() {
            const districtSelect = document.getElementById("districtSelect");
            const district = districtSelect.value;
            if (!district) {
                document.getElementById('districtStats').style.display = 'none';
                return;
            }

            const rows = data.filter(r => r.District === district);
            const totalVoters = rows.reduce((sum, r) => sum + r.RegisteredVoters, 0);
            const totalTurnout = rows.reduce((sum, r) => sum + r.TurnoutN, 0);
            const avgTurnoutPct = rows.length > 0 ? 
                (rows.reduce((sum, r) => sum + r.TurnoutPct, 0) / rows.length) : 0;
            const constituencies = rows.length;

            // Update stats
            document.getElementById('districtStats').innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${formatNumber(totalVoters)}</div>
                    <div class="stat-label">Registered Voters</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${formatNumber(totalTurnout)}</div>
                    <div class="stat-label">Actual Turnout</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${avgTurnoutPct.toFixed(1)}%</div>
                    <div class="stat-label">Turnout Rate</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${constituencies}</div>
                    <div class="stat-label">Constituencies</div>
                </div>
            `;
            document.getElementById('districtStats').style.display = 'grid';

            // Render chart
            if (charts.districtChart) {
                charts.districtChart.destroy();
            }

            const ctx = document.getElementById("districtChart").getContext("2d");
            charts.districtChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Voted', 'Did Not Vote'],
                    datasets: [{
                        data: [totalTurnout, totalVoters - totalTurnout],
                        backgroundColor: ['#28a745', '#dc3545'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Voter Participation in ${district} ${selectedYear ? '(' + selectedYear + ')' : ''}`
                        }
                    }
                }
            });
        }

        function updateComparison() {
            const compare1 = document.getElementById("compare1");
            const compare2 = document.getElementById("compare2");
            const d1 = compare1.value;
            const d2 = compare2.value;
            if (!d1 || !d2) return;

            const getStats = (district) => {
                const rows = data.filter(r => r.District === district);
                const totalVoters = rows.reduce((sum, r) => sum + r.RegisteredVoters, 0) / 1000000;
                const totalTurnout = rows.reduce((sum, r) => sum + r.TurnoutN, 0) / 1000000;
                const avgTurnoutPct = rows.length > 0 ? 
                    (rows.reduce((sum, r) => sum + r.TurnoutPct, 0) / rows.length) : 0;
                return [totalVoters, totalTurnout, avgTurnoutPct];
            };

            const stats1 = getStats(d1);
            const stats2 = getStats(d2);

            if (charts.compareChart) {
                charts.compareChart.destroy();
            }

            const ctx = document.getElementById("compareChart").getContext("2d");
            charts.compareChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Registered Voters (M)', 'Actual Turnout (M)', 'Turnout Rate (%)'],
                    datasets: [
                        {
                            label: d1,
                            data: stats1,
                            backgroundColor: 'rgba(0, 123, 255, 0.2)',
                            borderColor: 'rgba(0, 123, 255, 1)',
                            pointBackgroundColor: 'rgba(0, 123, 255, 1)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgba(0, 123, 255, 1)'
                        },
                        {
                            label: d2,
                            data: stats2,
                            backgroundColor: 'rgba(40, 167, 69, 0.2)',
                            borderColor: 'rgba(40, 167, 69, 1)',
                            pointBackgroundColor: 'rgba(40, 167, 69, 1)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgba(40, 167, 69, 1)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    elements: {
                        line: {
                            borderWidth: 3
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `District Comparison: ${d1} vs ${d2} ${selectedYear ? '(' + selectedYear + ')' : ''}`
                        }
                    }
                }
            });
        }

        function renderTrendsChart() {
            // Enhanced engagement analysis with concrete metrics
            const totalDistricts = data.length;
            const avgTurnout = data.length > 0 ? 
                (data.reduce((sum, row) => sum + row.TurnoutPct, 0) / data.length) : 0;
            
            // Group districts by turnout rate ranges for engagement analysis
            const ranges = [
                { min: 0, max: 30, label: 'Low Engagement\n(0-30%)', color: '#dc3545' },
                { min: 30, max: 50, label: 'Below Average\n(30-50%)', color: '#fd7e14' },
                { min: 50, max: 70, label: 'Good Engagement\n(50-70%)', color: '#ffc107' },
                { min: 70, max: 100, label: 'High Engagement\n(70%+)', color: '#28a745' }
            ];

            const engagementData = ranges.map(range => {
                const districtsInRange = data.filter(row => 
                    row.TurnoutPct >= range.min && row.TurnoutPct < range.max
                );
                const totalVotersInRange = districtsInRange.reduce((sum, row) => sum + row.RegisteredVoters, 0);
                const totalTurnoutInRange = districtsInRange.reduce((sum, row) => sum + row.TurnoutN, 0);
                const avgTurnoutInRange = districtsInRange.length > 0 ?
                    (districtsInRange.reduce((sum, row) => sum + row.TurnoutPct, 0) / districtsInRange.length) : 0;
                
                return {
                    label: range.label,
                    count: districtsInRange.length,
                    percentage: totalDistricts > 0 ? (districtsInRange.length / totalDistricts * 100) : 0,
                    totalVoters: totalVotersInRange / 1000000,
                    totalTurnout: totalTurnoutInRange / 1000000,
                    avgTurnout: avgTurnoutInRange,
                    color: range.color
                };
            });

            // Add summary stats
            const highEngagementDistricts = engagementData[3].count;
            const lowEngagementDistricts = engagementData[0].count;
            
            // Create detailed chart
            if (charts.trendsChart) {
                charts.trendsChart.destroy();
            }

            const ctx = document.getElementById("trendsChart").getContext("2d");
            charts.trendsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: engagementData.map(d => d.label.replace('\n', ' ')),
                    datasets: [
                        {
                            label: 'Number of Districts',
                            data: engagementData.map(d => d.count),
                            backgroundColor: engagementData.map(d => d.color + '90'),
                            borderColor: engagementData.map(d => d.color),
                            borderWidth: 2,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Avg Turnout Rate (%)',
                            data: engagementData.map(d => d.avgTurnout),
                            type: 'line',
                            borderColor: '#6f42c1',
                            backgroundColor: '#6f42c1',
                            borderWidth: 3,
                            fill: false,
                            yAxisID: 'y1',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Voter Engagement Analysis ${selectedYear ? '- ' + selectedYear : ''}\n` +
                                  `Total Districts: ${totalDistricts} | National Average: ${avgTurnout.toFixed(1)}%\n` +
                                  `High Engagement: ${highEngagementDistricts} districts | Low Engagement: ${lowEngagementDistricts} districts`,
                            font: {
                                size: 14
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const dataIndex = context.dataIndex;
                                    const data = engagementData[dataIndex];
                                    return [
                                        `Districts: ${data.count} (${data.percentage.toFixed(1)}%)`,
                                        `Total Voters: ${formatNumber(data.totalVoters * 1000000)}`,
                                        `Total Turnout: ${formatNumber(data.totalTurnout * 1000000)}`,
                                        `Avg Turnout: ${data.avgTurnout.toFixed(1)}%`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Districts'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Average Turnout Rate (%)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });

            // Add concrete insights below the chart
            const trendsContainer = document.getElementById('trends');
            const existingInsights = trendsContainer.querySelector('.insights');
            if (existingInsights) {
                existingInsights.remove();
            }

            const insightsDiv = document.createElement('div');
            insightsDiv.className = 'insights';
            insightsDiv.innerHTML = `
                <div class="chart-container" style="margin-top: 20px;">
                    <h3>üìä Key Insights ${selectedYear ? '(' + selectedYear + ')' : ''}</h3>
                    <div class="stats-grid">
                        <div class="stat-item" style="background: linear-gradient(45deg, #28a745, #20c997);">
                            <div class="stat-value" style="color: white;">${highEngagementDistricts}</div>
                            <div class="stat-label" style="color: #f8f9fa;">High Engagement Districts (70%+)</div>
                        </div>
                        <div class="stat-item" style="background: linear-gradient(45deg, #dc3545, #e74c3c);">
                            <div class="stat-value" style="color: white;">${lowEngagementDistricts}</div>
                            <div class="stat-label" style="color: #f8f9fa;">Low Engagement Districts (<30%)</div>
                        </div>
                        <div class="stat-item" style="background: linear-gradient(45deg, #6f42c1, #8e44ad);">
                            <div class="stat-value" style="color: white;">${avgTurnout.toFixed(1)}%</div>
                            <div class="stat-label" style="color: #f8f9fa;">National Average Turnout</div>
                        </div>
                        <div class="stat-item" style="background: linear-gradient(45deg, #17a2b8, #3498db);">
                            <div class="stat-value" style="color: white;">${((highEngagementDistricts / totalDistricts) * 100).toFixed(1)}%</div>
                            <div class="stat-label" style="color: #f8f9fa;">Districts with High Engagement</div>
                        </div>
                    </div>
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 0.95rem;">
                        <strong>Analysis Summary:</strong><br>
                        ‚Ä¢ <strong>${((highEngagementDistricts / totalDistricts) * 100).toFixed(1)}%</strong> of districts show high voter engagement (70%+ turnout)<br>
                        ‚Ä¢ <strong>${((lowEngagementDistricts / totalDistricts) * 100).toFixed(1)}%</strong> of districts have concerning low engagement (<30% turnout)<br>
                        ‚Ä¢ Most districts (${(((engagementData[1].count + engagementData[2].count) / totalDistricts) * 100).toFixed(1)}%) fall in the moderate engagement range<br>
                        ‚Ä¢ National average turnout is <strong>${avgTurnout.toFixed(1)}%</strong>, ${avgTurnout >= 50 ? 'indicating healthy' : avgTurnout >= 40 ? 'showing moderate' : 'revealing low'} democratic participation
                    </div>
                </div>
            `;
            trendsContainer.appendChild(insightsDiv);
        }

        // Initialize the application
        window.addEventListener('DOMContentLoaded', function() {
            loadData();
        });
    </script>
</body>
</html>
