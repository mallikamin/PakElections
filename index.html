<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Election Data Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .summary { margin-bottom: 20px; }
    select, #districtsSelect { margin: 5px 0; }
    table { border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px 12px; text-align: right; }
    th:first-child, td:first-child { text-align: left; }
  </style>
</head>
<body>

  <h1>Election Data Dashboard</h1>

  <div>
    <label for="yearSelect">Select Year: </label>
    <select id="yearSelect"></select>
  </div>

  <div class="summary">
    <p><strong>Total Registered Voters:</strong> <span id="totalRegisteredVoters">-</span></p>
    <p><strong>Total Turnout (Votes):</strong> <span id="totalTurnout">-</span></p>
    <p><strong>Turnout %:</strong> <span id="turnoutPercent">-</span></p>
    <p><strong>Number of Districts:</strong> <span id="numDistricts">-</span></p>
  </div>

  <canvas id="yearChart" width="800" height="400"></canvas>

  <hr>

  <h2>District-wise Analysis</h2>
  <div>
    <label for="districtsSelect">Select District(s) to Compare:</label><br/>
    <select id="districtsSelect" multiple size="6" style="width:300px;"></select>
  </div>

  <div id="districtAnalysis"></div>

  <script>
    // CSV raw URL - replace with your actual raw CSV link
    const csvUrl = 'https://raw.githubusercontent.com/mallikamin/PakElections/main/data.csv';

    let electionData = [];
    let years = [];
    let districts = [];

    // Elements
    const yearSelect = document.getElementById('yearSelect');
    const totalRegisteredVotersSpan = document.getElementById('totalRegisteredVoters');
    const totalTurnoutSpan = document.getElementById('totalTurnout');
    const turnoutPercentSpan = document.getElementById('turnoutPercent');
    const numDistrictsSpan = document.getElementById('numDistricts');
    const yearChartCtx = document.getElementById('yearChart').getContext('2d');

    const districtsSelect = document.getElementById('districtsSelect');
    const districtAnalysisDiv = document.getElementById('districtAnalysis');

    let yearChart;

    // Helper function: parse numeric values safely
    function parseNumber(val) {
      const num = Number(val);
      return isNaN(num) ? 0 : num;
    }

    // Load and parse CSV
    Papa.parse(csvUrl, {
      download: true,
      header: true,
      dynamicTyping: false,  // We'll parse numbers explicitly
      complete: function(results) {
        // Filter out empty rows (those without Year)
        electionData = results.data.filter(row => row.Year && row.Year.trim() !== '');
        initializeUI();
      },
      error: function(err) {
        alert('Error loading CSV: ' + err);
      }
    });

    function initializeUI() {
      // Unique years sorted
      years = [...new Set(electionData.map(row => row.Year.trim()))].sort();
      for (const y of years) {
        const option = document.createElement('option');
        option.value = y;
        option.textContent = y;
        yearSelect.appendChild(option);
      }

      // Unique districts sorted
      districts = [...new Set(electionData.map(row => row.District).filter(d => d && d.trim() !== '').map(d => d.trim()))].sort();
      districtsSelect.innerHTML = '';
      for (const d of districts) {
        const option = document.createElement('option');
        option.value = d;
        option.textContent = d;
        districtsSelect.appendChild(option);
      }

      yearSelect.addEventListener('change', onYearChange);
      districtsSelect.addEventListener('change', onDistrictsChange);

      // Default selection
      yearSelect.value = years[0];
      onYearChange();
    }

    function onYearChange() {
      const selectedYear = yearSelect.value.trim();

      // Filter data by selected year
      const yearData = electionData.filter(row => row.Year.trim() === selectedYear);

      // Aggregate Registered Voters per district, then sum districts for total
      const registeredByDistrict = {};
      yearData.forEach(row => {
        const district = row.District ? row.District.trim() : null;
        if (district) {
          registeredByDistrict[district] = (registeredByDistrict[district] || 0) + parseNumber(row['Registered Voters']);
        }
      });
      const totalRegisteredVoters = Object.values(registeredByDistrict).reduce((a, b) => a + b, 0);

      // Aggregate total votes, sum Votes column
      const totalTurnout = yearData.reduce((sum, row) => sum + parseNumber(row.Votes), 0);

      // Calculate turnout percentage
      const turnoutPercent = totalRegisteredVoters > 0 ? (totalTurnout / totalRegisteredVoters) * 100 : 0;

      // Number of districts with data
      const numDistricts = Object.keys(registeredByDistrict).length;

      // Update UI
      totalRegisteredVotersSpan.textContent = totalRegisteredVoters.toLocaleString();
      totalTurnoutSpan.textContent = totalTurnout.toLocaleString();
      turnoutPercentSpan.textContent = turnoutPercent.toFixed(2) + '%';
      numDistrictsSpan.textContent = numDistricts;

      updateYearChart();

      // Clear district selections and analysis
      districtAnalysisDiv.innerHTML = '';
      districtsSelect.selectedIndex = -1;
    }

    function aggregateByYear() {
      // Aggregate over all years by summing Registered Voters and Votes per year

      const aggregates = {};

      electionData.forEach(row => {
        const y = row.Year ? row.Year.trim() : null;
        const district = row.District ? row.District.trim() : null;
        if (!y || !district) return;

        if (!aggregates[y]) {
          aggregates[y] = { registeredByDistrict: {}, votes: 0 };
        }

        // Aggregate Registered Voters per district for that year
        aggregates[y].registeredByDistrict[district] = (aggregates[y].registeredByDistrict[district] || 0) + parseNumber(row['Registered Voters']);
        // Aggregate votes
        aggregates[y].votes += parseNumber(row.Votes);
      });

      // Prepare sorted arrays for chart
      const yearsSorted = Object.keys(aggregates).sort();
      const regVotersArr = [];
      const votesArr = [];

      yearsSorted.forEach(y => {
        const regSum = Object.values(aggregates[y].registeredByDistrict).reduce((a, b) => a + b, 0);
        regVotersArr.push(regSum);
        votesArr.push(aggregates[y].votes);
      });

      return { yearsSorted, regVotersArr, votesArr };
    }

    function updateYearChart() {
      const { yearsSorted, regVotersArr, votesArr } = aggregateByYear();

      if (yearChart) {
        yearChart.destroy();
      }

      yearChart = new Chart(yearChartCtx, {
        type: 'line',
        data: {
          labels: yearsSorted,
          datasets: [
            {
              label: 'Registered Voters',
              data: regVotersArr,
              borderColor: 'blue',
              fill: false,
              tension: 0.1,
            },
            {
              label: 'Turnout (Votes)',
              data: votesArr,
              borderColor: 'green',
              fill: false,
              tension: 0.1,
            }
          ]
        },
        options: {
          responsive: true,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
            title: {
              display: true,
              text: 'Year-wise Registered Voters vs Turnout'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ": " + context.parsed.y.toLocaleString();
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return value.toLocaleString();
                }
              }
            }
          }
        }
      });
    }

    // District-wise analysis (selected districts for selected year)
    function onDistrictsChange() {
      const selectedYear = yearSelect.value.trim();
      const selectedDistricts = Array.from(districtsSelect.selectedOptions).map(o => o.value.trim());

      if (selectedDistricts.length === 0) {
        districtAnalysisDiv.innerHTML = '<p>Please select one or more districts to compare.</p>';
        return;
      }

      // Filter data for selected year and districts
      const filteredData = electionData.filter(row => 
        row.Year && row.Year.trim() === selectedYear &&
        row.District && selectedDistricts.includes(row.District.trim())
      );

      // Aggregate Registered Voters and turnout per district
      const districtAggregates = {};
      selectedDistricts.forEach(district => {
        districtAggregates[district] = { registered: 0, turnout: 0 };
      });

      // Sum Registered Voters per district
      selectedDistricts.forEach(district => {
        const regSum = filteredData
          .filter(r => r.District.trim() === district)
          .reduce((sum, r) => sum + parseNumber(r['Registered Voters']), 0);
        districtAggregates[district].registered = regSum;
      });

      // Sum Votes per district for turnout
      filteredData.forEach(row => {
        const district = row.District.trim();
        if (districtAggregates[district]) {
          districtAggregates[district].turnout += parseNumber(row.Votes);
        }
      });

      // Build comparison HTML table
      let html = `<table>
        <thead>
          <tr>
            <th>District</th><th>Registered Voters</th><th>Turnout (Votes)</th><th>Turnout %</th>
          </tr>
        </thead>
        <tbody>`;

      selectedDistricts.forEach(district => {
        const reg = districtAggregates[district].registered;
        const turnout = districtAggregates[district].turnout;
        const percent = reg > 0 ? (turnout / reg) * 100 : 0;

        html += `<tr>
            <td>${district}</td>
            <td>${reg.toLocaleString()}</td>
            <td>${turnout.toLocaleString()}</td>
            <td>${percent.toFixed(2)}%</td>
          </tr>`;
      });

      html += '</tbody></table>';

      districtAnalysisDiv.innerHTML = html;
    }
  </script>

</body>
</html>
