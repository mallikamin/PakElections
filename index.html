<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Election Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            display: inline-block;
            background-color: #f1f1f1;
            margin-right: 5px;
            border-radius: 5px;
        }
        .tab.active {
            background-color: #007BFF;
            color: white;
        }
        .tab-content {
            display: none;
            margin-top: 20px;
        }
        .tab-content.active {
            display: block;
        }
        select {
            margin: 10px;
            padding: 5px;
        }
    </style>
</head>
<body>
<h1>Pakistan Election Dashboard</h1>
<div>
    <div class="tab active" data-tab="province">Province Overview</div>
    <div class="tab" data-tab="district">District View</div>
    <div class="tab" data-tab="compare">Compare Districts</div>
</div>
<div id="province" class="tab-content active">
    <select id="province-select"></select>
    <div id="province-chart"></div>
</div>
<div id="district" class="tab-content">
    <select id="district-select"></select>
    <div id="district-chart"></div>
</div>
<div id="compare" class="tab-content">
    <select id="compare-district1"></select>
    <select id="compare-district2"></select>
    <div id="compare-chart"></div>
</div>
<script>
    let data = [];
    let provinces = new Set();
    let districts = new Set();

    function parseCSV(text) {
        const rows = text.split(/\r?\n/);
        const headers = rows[0].split(',');
        return rows.slice(1).map(row => {
            const values = row.split(',');
            return headers.reduce((obj, header, i) => {
                obj[header.trim()] = values[i]?.trim();
                return obj;
            }, {});
        });
    }

    function populateSelectors() {
        provinces.forEach(p => $('#province-select').append(`<option value="${p}">${p}</option>`));
        districts.forEach(d => {
            $('#district-select, #compare-district1, #compare-district2')
                .append(`<option value="${d}">${d}</option>`);
        });
    }

    function updateProvinceChart(province) {
        const provinceData = data.filter(d => d['Province'] === province);
        const grouped = {};
        provinceData.forEach(row => {
            const dist = row['District'];
            const turnout = parseFloat(row['Turnout N']) || 0;
            const registered = parseFloat(row['Registered Voters']) || 1;
            const pct = Math.round((turnout / registered) * 100);
            if (!grouped[dist]) grouped[dist] = [];
            grouped[dist].push(pct);
        });
        const x = Object.keys(grouped);
        const y = x.map(d => Math.round(grouped[d].reduce((a,b)=>a+b,0)/grouped[d].length));
        Plotly.newPlot('province-chart', [{
            x, y, type: 'bar', text: y.map(p => p + '%'), textposition: 'auto'
        }], { title: `Voter Turnout by District in ${province}`, yaxis: { title: '% Turnout', range: [0, 100] }});
    }

    function updateDistrictChart(district) {
        const ddata = data.filter(d => d['District'] === district);
        const years = [...new Set(ddata.map(d => d['Year']))];
        const y = [];
        years.forEach(year => {
            const yearData = ddata.filter(d => d['Year'] === year);
            const turnout = yearData.reduce((sum, d) => sum + (+d['Turnout N'] || 0), 0);
            const reg = yearData.reduce((sum, d) => sum + (+d['Registered Voters'] || 0), 1);
            y.push(Math.round((turnout / reg) * 100));
        });
        Plotly.newPlot('district-chart', [{
            x: years,
            y,
            type: 'bar',
            text: y.map(p => p + '%'), textposition: 'auto'
        }], {
            title: `Voter Turnout in ${district} by Year`,
            yaxis: { title: '% Turnout', range: [0, 100] }
        });
    }

    function updateCompareChart(d1, d2) {
        const ddata1 = data.filter(d => d['District'] === d1);
        const ddata2 = data.filter(d => d['District'] === d2);
        const years = [...new Set([...ddata1, ...ddata2].map(d => d['Year']))];
        const y1 = [], y2 = [];
        years.forEach(year => {
            const yd1 = ddata1.filter(d => d['Year'] === year);
            const yd2 = ddata2.filter(d => d['Year'] === year);
            const t1 = yd1.reduce((sum, d) => sum + (+d['Turnout N'] || 0), 0);
            const r1 = yd1.reduce((sum, d) => sum + (+d['Registered Voters'] || 0), 1);
            const t2 = yd2.reduce((sum, d) => sum + (+d['Turnout N'] || 0), 0);
            const r2 = yd2.reduce((sum, d) => sum + (+d['Registered Voters'] || 0), 1);
            y1.push(Math.round((t1 / r1) * 100));
            y2.push(Math.round((t2 / r2) * 100));
        });
        Plotly.newPlot('compare-chart', [
            { x: years, y: y1, name: d1, type: 'bar', text: y1.map(p => p + '%'), textposition: 'auto' },
            { x: years, y: y2, name: d2, type: 'bar', text: y2.map(p => p + '%'), textposition: 'auto' }
        ], {
            title: `Comparison of Voter Turnout: ${d1} vs ${d2}`,
            barmode: 'group',
            yaxis: { title: '% Turnout', range: [0, 100] }
        });
    }

    $(document).ready(function() {
        fetch('data.csv')
            .then(res => res.text())
            .then(csv => {
                data = parseCSV(csv);
                data.forEach(d => {
                    if (d['Province']) provinces.add(d['Province']);
                    if (d['District']) districts.add(d['District']);
                });
                populateSelectors();
                updateProvinceChart($('#province-select').val());
                updateDistrictChart($('#district-select').val());
                updateCompareChart($('#compare-district1').val(), $('#compare-district2').val());
            });

        $('.tab').click(function() {
            $('.tab').removeClass('active');
            $(this).addClass('active');
            $('.tab-content').removeClass('active');
            $('#' + $(this).data('tab')).addClass('active');
        });

        $('#province-select').on('change', function() {
            updateProvinceChart(this.value);
        });
        $('#district-select').on('change', function() {
            updateDistrictChart(this.value);
        });
        $('#compare-district1, #compare-district2').on('change', function() {
            updateCompareChart($('#compare-district1').val(), $('#compare-district2').val());
        });
    });
</script>
</body>
</html>
